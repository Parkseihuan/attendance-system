<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏÑ∏ÎØ∏ÎÇòÏã§ Ï∂úÏÑù Ï≤¥ÌÅ¨</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 500px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #f9ca24);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .autocomplete-detected {
            background-color: #d4edda !important;
            border-color: #28a745 !important;
        }

        .warning-message, .error-message, .success-message {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            display: none;
        }

        .warning-message {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .error-message {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .success-message {
            background-color: #d1edff;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .submit-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .device-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 12px;
            color: #6c757d;
        }

        .timestamp {
            text-align: center;
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 20px;
        }

        .blocked-message {
            text-align: center;
            color: #e74c3c;
            font-size: 18px;
            font-weight: 600;
        }

        .manual-instruction {
            background: #e8f4f8;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .manual-instruction h3 {
            color: #17a2b8;
            margin-bottom: 10px;
        }

        .fingerprint-info {
            font-size: 10px;
            color: #adb5bd;
            margin-top: 10px;
            text-align: center;
        }

        .location-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .location-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(40, 167, 69, 0.3);
        }

        .location-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .location-btn.checking {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }

        .location-btn.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .location-btn.error {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .location-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .location-result {
            font-size: 14px;
            line-height: 1.5;
        }

        .location-success {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .location-error {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .coordinates-info {
            font-size: 12px;
            color: #6c757d;
            margin-top: 8px;
            font-family: monospace;
            background: #f1f3f4;
            padding: 8px;
            border-radius: 4px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .modal-message {
            font-size: 16px;
            color: #555;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .modal-close-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .modal-icon.success { color: #28a745; }
        .modal-icon.error { color: #dc3545; }
        .modal-icon.warning { color: #ffc107; }

        @media (max-width: 600px) {
            .container {
                padding: 30px 20px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container rounded-xl">
        <div class="header">
            <h1>üéì ÏÑ∏ÎØ∏ÎÇòÏã§ Ï∂úÏÑù Ï≤¥ÌÅ¨</h1>
            <p>ÌñâÏÇ¨ Ï∞∏ÏÑù ÌôïÏù∏ÏùÑ ÏúÑÌï¥ Ï†ïÎ≥¥Î•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî</p>
        </div>

        <div id="attendanceForm">
            <form id="checkInForm">
                <div class="form-group">
                    <label for="name">Ïù¥Î¶Ñ *</label>
                    <input type="text" id="name" name="name" required autocomplete="name" class="rounded-lg">
                </div>

                <div class="form-group">
                    <label for="affiliation">ÏÜåÏÜç *</label>
                    <input type="text" id="affiliation" name="affiliation" required autocomplete="organization" class="rounded-lg">
                </div>

                <div class="form-group">
                    <label for="email">Ïù¥Î©îÏùº</label>
                    <input type="email" id="email" name="email" autocomplete="email" class="rounded-lg">
                </div>

                <div class="form-group">
                    <label for="phone">Ïó∞ÎùΩÏ≤ò</label>
                    <input type="tel" id="phone" name="phone" autocomplete="tel" class="rounded-lg">
                </div>

                <div class="form-group">
                    <label for="location">ÏúÑÏπò ÌôïÏù∏ *</label>
                    <div class="location-status" id="locationStatus">
                        <button type="button" class="location-btn rounded-lg" id="locationBtn">
                            üìç ÌòÑÏû¨ ÏúÑÏπò ÌôïÏù∏
                        </button>
                        <div class="location-info rounded-lg" id="locationInfo" style="display: none;">
                            <div class="location-result" id="locationResult"></div>
                        </div>
                    </div>
                    <input type="hidden" id="location" name="location" required>
                    <input type="hidden" id="coordinates" name="coordinates">
                </div>

                <div class="warning-message rounded-lg" id="warningMessage">
                    ‚ö†Ô∏è ÏûÖÎ†•ÌïòÏã† Ï†ïÎ≥¥ÏôÄ Î∏åÎùºÏö∞Ï†ÄÏóê Ï†ÄÏû•Îêú Ï†ïÎ≥¥Í∞Ä Îã§Î¶ÖÎãàÎã§. Ï†ïÌôïÌïú Ï†ïÎ≥¥Ïù∏ÏßÄ ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî.
                </div>

                <button type="submit" class="submit-btn rounded-lg" id="submitBtn">Ï∂úÏÑù Ï≤¥ÌÅ¨ ÏôÑÎ£å</button>
            </form>

            <div class="manual-instruction rounded-r-lg">
                <h3>üì± Ìú¥ÎåÄÌè∞ ÏÇ¨Ïö©Ïù¥ Ïñ¥Î†§Ïö∞Ïã† Í≤ΩÏö∞</h3>
                <p>ÌñâÏÇ¨Ïû• ÏïûÏ™ΩÏóê ÎπÑÏπòÎêú <strong>'Ï∞∏ÏÑùÏûê Î™ÖÎ∂Ä'</strong>Ïóê ÏßÅÏ†ë Í∏∞Ïû¨Ìï¥ Ï£ºÏãúÍ∏∞ Î∞îÎûçÎãàÎã§.</p>
            </div>

            <div class="device-info rounded-lg" id="deviceInfo"></div>
            <div class="fingerprint-info">
                Î≥¥ÏïàÏùÑ ÏúÑÌï¥ Í∏∞Í∏∞ Ï†ïÎ≥¥Î•º ÏàòÏßëÌï©ÎãàÎã§ (Ï§ëÎ≥µ Ï≤¥ÌÅ¨ Î∞©ÏßÄÏö©)
            </div>
        </div>

        <div id="blockedMessage" style="display: none;">
            <div class="blocked-message">
                <h2>üö´ Ïù¥ÎØ∏ Ï∂úÏÑù Ï≤¥ÌÅ¨ ÏôÑÎ£å</h2>
                <p>Ïù¥ Í∏∞Í∏∞ÏóêÏÑúÎäî Ïù¥ÎØ∏ Ï∂úÏÑù Ï≤¥ÌÅ¨Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.</p>
                <div class="manual-instruction rounded-r-lg">
                    <h3>Îã§Î•∏ Î∞©Î≤ïÏúºÎ°ú Ï∂úÏÑù Ï≤¥ÌÅ¨</h3>
                    <p>ÌñâÏÇ¨Ïû• ÏïûÏ™ΩÏóê ÎπÑÏπòÎêú <strong>'Ï∞∏ÏÑùÏûê Î™ÖÎ∂Ä'</strong>Ïóê ÏßÅÏ†ë Í∏∞Ïû¨Ìï¥ Ï£ºÏÑ∏Ïöî.</p>
                </div>
            </div>
        </div>

        <div class="timestamp" id="timestamp"></div>
    </div>

    <!-- Custom Modal for Alerts -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-content rounded-xl">
            <div id="modalIcon" class="modal-icon"></div>
            <h3 id="modalTitle" class="modal-title"></h3>
            <p id="modalMessage" class="modal-message"></p>
            <button id="modalCloseBtn" class="modal-close-btn rounded-lg">ÌôïÏù∏</button>
        </div>
    </div>

    <script>
        // Íµ¨ÏÑ± ÏÑ§Ï†ï
        const CONFIG = {
            // Google Apps Script URL (Ïã§Ï†ú Î∞∞Ìè¨Îêú URLÎ°ú Î≥ÄÍ≤Ω ÌïÑÏöî)
            GOOGLE_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycby2Ud9x9UUL8-3H6TE2tZfmLr-Cfd1zTFcI9qD_r2v8WSsoxywM6o_ApHmgbbQQ1jse/exec',
            // Ïû¨ÏãúÎèÑ ÏÑ§Ï†ï
            MAX_RETRIES: 3,
            RETRY_DELAY: 1000, // 1Ï¥à
            
            // ÏúÑÏπò ÏÑ§Ï†ï
            GPS_TIMEOUT: 15000, // 15Ï¥à
            GPS_MAX_AGE: 300000, // 5Î∂Ñ
            
            // ÌóàÏö©Îêú ÏúÑÏπò (Ïã§Ï†ú Ï¢åÌëúÎ°ú Î≥ÄÍ≤Ω ÌïÑÏöî)
            ALLOWED_LOCATIONS: [
                {
                    name: "Îã®Ìò∏ÌôÄ",
                    lat: 37.228848,
                    lng: 127.167855,
                    radius: 30
                },
                {
                    name: "Î≤ΩÏÜåÌôÄ", 
                    lat: 37.228767,
                    lng: 127.167449,
                    radius: 30
                },
                {
                    name: "ÎåÄÌïôÍµê Î≥∏Í¥Ä",
                    lat: 37.227239,
                    lng: 127.166598,
                    radius: 50
                }
            ]
        };

        class AttendanceSystem {
            constructor() {
                this.deviceFingerprint = this.generateDeviceFingerprint();
                this.autocompleteData = {};
                this.currentLocation = null;
                this.locationVerified = false;
                this.submissionAttempts = 0;
                this.init();
            }

            generateDeviceFingerprint() {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    ctx.textBaseline = 'top';
                    ctx.font = '14px Arial';
                    ctx.fillText('Device fingerprint test', 2, 2);
                    
                    const fingerprint = {
                        userAgent: navigator.userAgent,
                        language: navigator.language,
                        languages: navigator.languages?.join(',') || '',
                        platform: navigator.platform,
                        screen: `${screen.width}x${screen.height}x${screen.colorDepth}`,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                        canvas: canvas.toDataURL(),
                        cookieEnabled: navigator.cookieEnabled,
                        doNotTrack: navigator.doNotTrack || 'unspecified',
                        hardwareConcurrency: navigator.hardwareConcurrency || 0,
                        touchSupport: 'ontouchstart' in window,
                        webglRenderer: this.getWebGLRenderer()
                    };

                    return this.simpleHash(JSON.stringify(fingerprint));
                } catch (error) {
                    console.warn('Fingerprint generation error:', error);
                    return this.simpleHash(navigator.userAgent + Date.now());
                }
            }

            getWebGLRenderer() {
                try {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    if (gl) {
                        const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                        return debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : 'unknown';
                    }
                    return 'not_supported';
                } catch (error) {
                    return 'error';
                }
            }

            simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(36);
            }

            init() {
                this.updateTimestamp();
                this.displayDeviceInfo();
                
                if (this.checkIfBlocked()) {
                    return;
                }
                
                this.setupEventListeners();
                this.detectAutocomplete();
                
                setInterval(() => this.updateTimestamp(), 1000);
            }

            checkIfBlocked() {
                const sessionBlocked = sessionStorage.getItem('attendance_submitted');
                const deviceBlocked = localStorage.getItem(`attendance_${this.deviceFingerprint}`);
                
                const cookies = document.cookie.split(';').map(c => c.trim());
                const cookieBlocked = cookies.some(cookie => 
                    cookie.startsWith(`attendance_${this.deviceFingerprint}=`)
                );

                if (sessionBlocked || deviceBlocked || cookieBlocked) {
                    this.showBlockedMessage();
                    return true;
                }
                return false;
            }

            showBlockedMessage() {
                document.getElementById('attendanceForm').style.display = 'none';
                document.getElementById('blockedMessage').style.display = 'block';
            }

            setupEventListeners() {
                const form = document.getElementById('checkInForm');
                const inputs = form.querySelectorAll('input[autocomplete]');

                inputs.forEach(input => {
                    input.addEventListener('input', () => this.checkAutocompleteMatch(input));
                    input.addEventListener('change', () => this.checkAutocompleteMatch(input));
                });

                document.getElementById('locationBtn').addEventListener('click', () => this.checkLocation());
                document.getElementById('modalCloseBtn').addEventListener('click', () => this.hideModal());
                
                form.addEventListener('submit', (e) => this.handleSubmit(e));

                // ÌéòÏù¥ÏßÄ Ïà®ÍπÄ/ÌëúÏãú Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨ (Î™®Î∞îÏùº Î∏åÎùºÏö∞Ï†Ä ÎåÄÏùë)
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        this.updateTimestamp();
                    }
                });
            }

            detectAutocomplete() {
                setTimeout(() => {
                    const inputs = document.querySelectorAll('input[autocomplete]');
                    inputs.forEach(input => {
                        if (input.value && input.value.trim() !== '') {
                            this.autocompleteData[input.name] = input.value.trim();
                            input.classList.add('autocomplete-detected');
                        }
                    });
                }, 500);
            }

            checkAutocompleteMatch(input) {
                const fieldName = input.name;
                const currentValue = input.value.trim();
                const autocompleteValue = this.autocompleteData[fieldName];

                if (autocompleteValue && currentValue && 
                    currentValue.toLowerCase() !== autocompleteValue.toLowerCase()) {
                    this.showWarning('‚ö†Ô∏è ÏûÖÎ†•ÌïòÏã† Ï†ïÎ≥¥ÏôÄ Î∏åÎùºÏö∞Ï†Ä ÏûêÎèôÏôÑÏÑ± Ï†ïÎ≥¥Í∞Ä Îã§Î¶ÖÎãàÎã§.');
                } else {
                    this.hideWarning();
                }
            }

            showWarning(message) {
                const warningDiv = document.getElementById('warningMessage');
                warningDiv.textContent = message;
                warningDiv.style.display = 'block';
            }

            hideWarning() {
                document.getElementById('warningMessage').style.display = 'none';
            }

            showModal(type, title, message) {
                const modalOverlay = document.getElementById('customModal');
                const modalIcon = document.getElementById('modalIcon');
                const modalTitle = document.getElementById('modalTitle');
                const modalMessage = document.getElementById('modalMessage');

                modalIcon.className = `modal-icon ${type}`;
                switch(type) {
                    case 'success': modalIcon.textContent = '‚úÖ'; break;
                    case 'error': modalIcon.textContent = '‚ùå'; break;
                    case 'warning': modalIcon.textContent = '‚ö†Ô∏è'; break;
                    default: modalIcon.textContent = '‚ÑπÔ∏è';
                }

                modalTitle.textContent = title;
                modalMessage.innerHTML = message;
                
                modalOverlay.classList.add('active');
            }

            hideModal() {
                document.getElementById('customModal').classList.remove('active');
            }

            async checkLocation() {
                const locationBtn = document.getElementById('locationBtn');
                const locationInfo = document.getElementById('locationInfo');
                const locationResult = document.getElementById('locationResult');

                this.setLocationButtonState('checking');
                locationInfo.style.display = 'block';

                try {
                    if (!navigator.geolocation) {
                        throw new Error('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî GPS Í∏∞Îä•ÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                    }

                    const position = await this.getCurrentPosition();
                    const { latitude, longitude, accuracy } = position.coords;

                    console.log(`GPS Ï†ïÌôïÎèÑ: ${accuracy}m`);

                    const allowedLocation = this.isLocationAllowed(latitude, longitude);

                    if (allowedLocation) {
                        this.locationVerified = true;
                        this.currentLocation = {
                            lat: latitude,
                            lng: longitude,
                            name: allowedLocation.name,
                            distance: allowedLocation.distance,
                            accuracy: accuracy
                        };

                        this.setLocationButtonState('success');
                        
                        locationResult.innerHTML = `
                            <div class="location-success">
                                <strong>‚úÖ ÏúÑÏπò ÌôïÏù∏ ÏÑ±Í≥µ!</strong><br>
                                ÌòÑÏû¨ ÏúÑÏπò: ${allowedLocation.name}<br>
                                Í±∞Î¶¨: ÏïΩ ${Math.round(allowedLocation.distance)}m<br>
                                Ï†ïÌôïÎèÑ: ¬±${Math.round(accuracy)}m
                            </div>
                            <div class="coordinates-info">
                                Ï¢åÌëú: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}
                            </div>
                        `;

                        document.getElementById('location').value = allowedLocation.name;
                        document.getElementById('coordinates').value = `${latitude},${longitude}`;

                    } else {
                        throw new Error(`ÌóàÏö©Îêú ÏúÑÏπòÍ∞Ä ÏïÑÎãôÎãàÎã§. ÏÑ∏ÎØ∏ÎÇòÏã§ ÎÇ¥Î∂ÄÏóêÏÑú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî. (Ï†ïÌôïÎèÑ: ¬±${Math.round(accuracy)}m)`);
                    }

                } catch (error) {
                    console.error('ÏúÑÏπò ÌôïÏù∏ Ïò§Î•ò:', error);
                    this.handleLocationError(error, locationResult);
                }
            }

            setLocationButtonState(state) {
                const locationBtn = document.getElementById('locationBtn');
                locationBtn.disabled = state === 'checking';
                
                switch(state) {
                    case 'checking':
                        locationBtn.className = 'location-btn checking';
                        locationBtn.innerHTML = 'üîÑ ÏúÑÏπò ÌôïÏù∏ Ï§ë...';
                        break;
                    case 'success':
                        locationBtn.className = 'location-btn success';
                        locationBtn.innerHTML = '‚úÖ ÏúÑÏπò ÌôïÏù∏ ÏôÑÎ£å';
                        break;
                    case 'error':
                        locationBtn.className = 'location-btn error';
                        locationBtn.innerHTML = '‚ùå ÏúÑÏπò ÌôïÏù∏ Ïã§Ìå®';
                        setTimeout(() => {
                            locationBtn.disabled = false;
                            locationBtn.className = 'location-btn';
                            locationBtn.innerHTML = 'üìç ÏúÑÏπò Îã§Ïãú ÌôïÏù∏';
                        }, 3000);
                        break;
                }
            }

            handleLocationError(error, locationResult) {
                this.setLocationButtonState('error');
                this.locationVerified = false;
                
                document.getElementById('location').value = '';
                document.getElementById('coordinates').value = '';

                let errorMessage = error.message;
                let helpText = '';

                if (error.code) {
                    switch (error.code) {
                        case 1: // PERMISSION_DENIED
                            helpText = '‚Ä¢ Î∏åÎùºÏö∞Ï†Ä Ï£ºÏÜåÏ∞ΩÏùò ÏúÑÏπò ÏïÑÏù¥ÏΩòÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî<br>‚Ä¢ ÏÑ§Ï†ï > Í∞úÏù∏Ï†ïÎ≥¥ Î≥¥Ìò∏ > ÏúÑÏπò ÏÑúÎπÑÏä§ÏóêÏÑú ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî';
                            break;
                        case 2: // POSITION_UNAVAILABLE
                            helpText = '‚Ä¢ WiFiÎ•º ÏºúÏ£ºÏÑ∏Ïöî<br>‚Ä¢ Í±¥Î¨º Î∞ñÏóêÏÑú Ìïú Î≤à ÏãúÎèÑÌï¥Î≥¥ÏÑ∏Ïöî<br>‚Ä¢ Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî';
                            break;
                        case 3: // TIMEOUT
                            helpText = '‚Ä¢ ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî<br>‚Ä¢ WiFi Ïã†Ìò∏Í∞Ä Í∞ïÌïú Í≥≥ÏóêÏÑú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî';
                            break;
                    }
                }

                locationResult.innerHTML = `
                    <div class="location-error">
                        <strong>‚ùå ÏúÑÏπò ÌôïÏù∏ Ïã§Ìå®</strong><br>
                        ${errorMessage}<br><br>
                        <small style="font-size: 12px; line-height: 1.4;">
                            ${helpText || '‚Ä¢ GPS Í∂åÌïúÏùÑ ÌóàÏö©Ìï¥ Ï£ºÏÑ∏Ïöî<br>‚Ä¢ ÏÑ∏ÎØ∏ÎÇòÏã§ ÎÇ¥Î∂ÄÏóêÏÑú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî<br>‚Ä¢ WiFiÏôÄ ÏúÑÏπò ÏÑúÎπÑÏä§Î•º ÏºúÏ£ºÏÑ∏Ïöî'}
                        </small>
                    </div>
                `;

                this.showModal('error', 'ÏúÑÏπò ÌôïÏù∏ Ïã§Ìå®', errorMessage);
            }

            getCurrentPosition() {
                return new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        resolve,
                        reject,
                        {
                            enableHighAccuracy: true,
                            timeout: CONFIG.GPS_TIMEOUT,
                            maximumAge: CONFIG.GPS_MAX_AGE
                        }
                    );
                });
            }

            isLocationAllowed(lat, lng) {
                for (const location of CONFIG.ALLOWED_LOCATIONS) {
                    const distance = this.calculateDistance(lat, lng, location.lat, location.lng);
                    if (distance <= location.radius) {
                        return { name: location.name, distance: distance };
                    }
                }
                return null;
            }

            calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371e3;
                const œÜ1 = lat1 * Math.PI/180;
                const œÜ2 = lat2 * Math.PI/180;
                const ŒîœÜ = (lat2-lat1) * Math.PI/180;
                const ŒîŒª = (lng2-lng1) * Math.PI/180;

                const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                          Math.cos(œÜ1) * Math.cos(œÜ2) *
                          Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                return R * c;
            }

            async handleSubmit(e) {
                e.preventDefault();
                
                if (this.checkIfBlocked()) {
                    return;
                }

                const formData = new FormData(e.target);
                const submitBtn = document.getElementById('submitBtn');
                
                submitBtn.disabled = true;
                submitBtn.textContent = 'Ï†úÏ∂ú Ï§ë...';

                try {
                    if (!this.validateForm(formData)) {
                        return;
                    }

                    await this.submitDataWithRetry(formData);

                    this.markAsSubmitted();
                    this.showModal('success', 'Ï∂úÏÑù Ï≤¥ÌÅ¨ ÏôÑÎ£å!', '‚úÖ Ï∂úÏÑù Ï≤¥ÌÅ¨Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.');
                    
                    setTimeout(() => {
                        this.showBlockedMessage();
                    }, 2000);

                } catch (error) {
                    console.error('Ï†úÏ∂ú Ïò§Î•ò:', error);
                    this.showModal('error', 'Ï†úÏ∂ú Ïã§Ìå®', 
                        `‚ùå Ï∂úÏÑù Ï≤¥ÌÅ¨ Ï†úÏ∂úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.<br><small>${error.message}</small>`);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Ï∂úÏÑù Ï≤¥ÌÅ¨ ÏôÑÎ£å';
                }
            }

            validateForm(formData) {
                const name = formData.get('name')?.trim();
                const affiliation = formData.get('affiliation')?.trim();
                const location = formData.get('location');

                if (!name || !affiliation) {
                    this.showModal('warning', 'ÌïÑÏàò Ìï≠Î™© ÎàÑÎùΩ', 
                        'Ïù¥Î¶ÑÍ≥º ÏÜåÏÜçÏùÄ ÌïÑÏàò ÏûÖÎ†• Ìï≠Î™©ÏûÖÎãàÎã§.');
                    return false;
                }

                if (name.length < 2 || name.length > 50) {
                    this.showModal('warning', 'Ïù¥Î¶Ñ Ïò§Î•ò', 
                        'Ïù¥Î¶ÑÏùÄ 2Ïûê Ïù¥ÏÉÅ 50Ïûê Ïù¥ÌïòÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return false;
                }

                if (affiliation.length < 2 || affiliation.length > 100) {
                    this.showModal('warning', 'ÏÜåÏÜç Ïò§Î•ò', 
                        'ÏÜåÏÜçÏùÄ 2Ïûê Ïù¥ÏÉÅ 100Ïûê Ïù¥ÌïòÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return false;
                }

                if (!this.locationVerified || !location) {
                    this.showModal('warning', 'ÏúÑÏπò ÎØ∏ÌôïÏù∏', 
                        'GPS ÏúÑÏπò ÌôïÏù∏ÏùÑ Î®ºÏ†Ä ÏôÑÎ£åÌï¥ Ï£ºÏÑ∏Ïöî.');
                    return false;
                }

                return true;
            }

            async submitDataWithRetry(formData) {
                this.submissionAttempts = 0;
                
                while (this.submissionAttempts < CONFIG.MAX_RETRIES) {
                    try {
                        this.submissionAttempts++;
                        return await this.submitData(formData);
                    } catch (error) {
                        console.warn(`Ï†úÏ∂ú ÏãúÎèÑ ${this.submissionAttempts}/${CONFIG.MAX_RETRIES} Ïã§Ìå®:`, error);
                        
                        if (this.submissionAttempts >= CONFIG.MAX_RETRIES) {
                            throw new Error(`${CONFIG.MAX_RETRIES}Î≤à ÏãúÎèÑ ÌõÑ Ïã§Ìå®: ${error.message}`);
                        }
                        
                        // Ïû¨ÏãúÎèÑ Ï†Ñ ÎåÄÍ∏∞
                        await new Promise(resolve => 
                            setTimeout(resolve, CONFIG.RETRY_DELAY * this.submissionAttempts)
                        );
                    }
                }
            }

            async submitData(formData) {
                const submitData = {
                    name: formData.get('name')?.trim(),
                    affiliation: formData.get('affiliation')?.trim(),
                    email: formData.get('email')?.trim() || '',
                    phone: formData.get('phone')?.trim() || '',
                    location: formData.get('location'),
                    coordinates: formData.get('coordinates') || '',
                    timestamp: new Date().toISOString(),
                    timestampKor: new Date().toLocaleString('ko-KR'),
                    deviceId: this.deviceFingerprint,
                    userAgent: navigator.userAgent,
                    submissionAttempt: this.submissionAttempts
                };

                if (CONFIG.GOOGLE_SCRIPT_URL && !CONFIG.GOOGLE_SCRIPT_URL.includes('YOUR_SCRIPT_ID')) {
                    console.log('Google Apps ScriptÎ°ú Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ° ÏãúÎèÑ Ï§ë...');
                    return await this.submitToAppsScript(submitData);
                }
                
                console.warn('Google Apps Script URLÏù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                console.log('Ï†úÏ∂ú Îç∞Ïù¥ÌÑ∞ (ÏãúÎÆ¨Î†àÏù¥ÏÖò):', submitData);
                
                // Í∞úÎ∞ú/ÌÖåÏä§Ìä∏ Î™®Îìú ÏãúÎÆ¨Î†àÏù¥ÏÖò
                await new Promise(resolve => setTimeout(resolve, 1000));
                return { success: true, message: 'URL ÎØ∏ÏÑ§Ï†ïÏúºÎ°ú ÏãúÎÆ¨Î†àÏù¥ÏÖòÎê®' };
            }

            async submitToAppsScript(data) {
                // Î∞©Î≤ï 1: no-cors Î™®ÎìúÎ°ú ÏãúÎèÑ (ÏùëÎãµ ÌôïÏù∏ Î∂àÍ∞ÄÌïòÏßÄÎßå Ï†ÑÏÜ°Îê®)
                try {
                    console.log('Apps Script URL:', CONFIG.GOOGLE_SCRIPT_URL);
                    console.log('Ï†úÏ∂ú Îç∞Ïù¥ÌÑ∞:', data);

                    const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', // CORS Ïö∞Ìöå
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    // no-cors Î™®ÎìúÏóêÏÑúÎäî ÏùëÎãµ ÎÇ¥Ïö©ÏùÑ ÌôïÏù∏Ìï† Ïàò ÏóÜÏùå
                    // ÌïòÏßÄÎßå ÏöîÏ≤≠ÏùÄ ÏÑúÎ≤ÑÏóê Ï†ÑÎã¨Îê®
                    console.log('no-cors Î™®ÎìúÎ°ú Ï†ÑÏÜ° ÏôÑÎ£å (ÏùëÎãµ ÌôïÏù∏ Î∂àÍ∞Ä)');
                    return { success: true, message: 'no-cors Î™®ÎìúÎ°ú Ï†ÑÏÜ°Îê®', mode: 'no-cors' };

                } catch (noCorsError) {
                    console.warn('no-cors Î™®Îìú Ïã§Ìå®, JSONP Î∞©ÏãùÏúºÎ°ú Ïû¨ÏãúÎèÑ:', noCorsError);
                    
                    // Î∞©Î≤ï 2: JSONP Î∞©ÏãùÏúºÎ°ú Ïû¨ÏãúÎèÑ
                    return await this.submitViaJSONP(data);
                }
            }

            async submitViaJSONP(data) {
                return new Promise((resolve, reject) => {
                    const callbackName = 'jsonpCallback' + Date.now() + Math.floor(Math.random() * 1000);
                    
                    console.log('JSONP ÏöîÏ≤≠ ÏãúÏûë:', callbackName);
                    
                    // Ï†ÑÏó≠ ÏΩúÎ∞± Ìï®Ïàò Îì±Î°ù
                    window[callbackName] = function(response) {
                        console.log('JSONP ÏΩúÎ∞± Ïã§ÌñâÎê®:', response);
                        cleanup();
                        resolve(response);
                    };

                    // ÏóêÎü¨ Ï≤òÎ¶¨Î•º ÏúÑÌïú ÌÉÄÏûÑÏïÑÏõÉ
                    const timeoutId = setTimeout(() => {
                        console.warn('JSONP ÌÉÄÏûÑÏïÑÏõÉ Î∞úÏÉù');
                        cleanup();
                        reject(new Error('JSONP ÏöîÏ≤≠ ÌÉÄÏûÑÏïÑÏõÉ (15Ï¥à)'));
                    }, 15000);

                    const cleanup = () => {
                        if (window[callbackName]) {
                            delete window[callbackName];
                        }
                        if (script && script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        if (timeoutId) {
                            clearTimeout(timeoutId);
                        }
                    };

                    // URL ÌååÎùºÎØ∏ÌÑ∞ ÏÉùÏÑ±
                    const params = new URLSearchParams();
                    params.append('callback', callbackName);
                    params.append('data', JSON.stringify(data));
                    
                    const fullUrl = `${CONFIG.GOOGLE_SCRIPT_URL}?${params.toString()}`;
                    console.log('JSONP ÏöîÏ≤≠ URL:', fullUrl);

                    // Ïä§ÌÅ¨Î¶ΩÌä∏ ÌÉúÍ∑∏ ÏÉùÏÑ±
                    const script = document.createElement('script');
                    script.src = fullUrl;
                    script.onload = function() {
                        console.log('JSONP Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú ÏÑ±Í≥µ');
                    };
                    script.onerror = function(event) {
                        console.error('JSONP Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú Ïã§Ìå®:', event);
                        cleanup();
                        reject(new Error('JSONP Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú Ïã§Ìå®'));
                    };

                    // DOMÏóê Ïä§ÌÅ¨Î¶ΩÌä∏ Ï∂îÍ∞Ä
                    console.log('JSONP Ïä§ÌÅ¨Î¶ΩÌä∏ DOMÏóê Ï∂îÍ∞Ä');
                    document.head.appendChild(script);
                });
            }

            markAsSubmitted() {
                const timestamp = Date.now().toString();
                
                try {
                    sessionStorage.setItem('attendance_submitted', 'true');
                    sessionStorage.setItem('attendance_timestamp', timestamp);
                } catch (e) {
                    console.warn('SessionStorage Ï†ÄÏû• Ïã§Ìå®:', e);
                }

                try {
                    localStorage.setItem(`attendance_${this.deviceFingerprint}`, timestamp);
                } catch (e) {
                    console.warn('LocalStorage Ï†ÄÏû• Ïã§Ìå®:', e);
                }
                
                try {
                    document.cookie = `attendance_${this.deviceFingerprint}=submitted; max-age=${30*24*60*60}; path=/; SameSite=Lax; Secure`;
                } catch (e) {
                    console.warn('Cookie Ï†ÄÏû• Ïã§Ìå®:', e);
                }
            }

            updateTimestamp() {
                try {
                    const now = new Date();
                    const timeString = now.toLocaleString('ko-KR', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        weekday: 'short'
                    });
                    document.getElementById('timestamp').textContent = `ÌòÑÏû¨ ÏãúÍ∞Ñ: ${timeString}`;
                } catch (error) {
                    console.warn('ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
                }
            }

            displayDeviceInfo() {
                try {
                    const deviceInfo = document.getElementById('deviceInfo');
                    const browserName = this.getBrowserName();
                    const osName = this.getOSName();
                    
                    deviceInfo.innerHTML = `
                        <strong>Í∏∞Í∏∞ Ï†ïÎ≥¥:</strong><br>
                        Î∏åÎùºÏö∞Ï†Ä: ${browserName}<br>
                        Ïö¥ÏòÅÏ≤¥Ï†ú: ${osName}<br>
                        ÌôîÎ©¥: ${screen.width}√ó${screen.height} (${screen.colorDepth}bit)<br>
                        Ïñ∏Ïñ¥: ${navigator.language}<br>
                        ÌÑ∞Ïπò: ${('ontouchstart' in window) ? 'ÏßÄÏõê' : 'ÎØ∏ÏßÄÏõê'}<br>
                        Í∏∞Í∏∞ ID: ${this.deviceFingerprint.substring(0, 8)}...
                    `;
                } catch (error) {
                    console.warn('Í∏∞Í∏∞ Ï†ïÎ≥¥ ÌëúÏãú Ïò§Î•ò:', error);
                }
            }

            getBrowserName() {
                const ua = navigator.userAgent;
                if (ua.includes('Chrome')) return 'Chrome';
                if (ua.includes('Firefox')) return 'Firefox';
                if (ua.includes('Safari')) return 'Safari';
                if (ua.includes('Edge')) return 'Edge';
                return 'Unknown';
            }

            getOSName() {
                const ua = navigator.userAgent;
                if (ua.includes('Windows')) return 'Windows';
                if (ua.includes('Mac')) return 'macOS';
                if (ua.includes('Linux')) return 'Linux';
                if (ua.includes('Android')) return 'Android';
                if (ua.includes('iPhone') || ua.includes('iPad')) return 'iOS';
                return navigator.platform || 'Unknown';
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú ÏôÑÎ£å Ïãú ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', () => {
            try {
                new AttendanceSystem();
            } catch (error) {
                console.error('AttendanceSystem Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
                alert('ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
            }
        });

        // Ï†ÑÏó≠ ÏóêÎü¨ Ìï∏Îì§Îü¨
        window.addEventListener('error', (event) => {
            console.error('Ï†ÑÏó≠ Ïò§Î•ò:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Ï≤òÎ¶¨ÎêòÏßÄ ÏïäÏùÄ Promise Í±∞Î∂Ä:', event.reason);
        });
    </script>
</body>
</html>
