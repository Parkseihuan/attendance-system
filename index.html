<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏÑ∏ÎØ∏ÎÇòÏã§ Ï∂úÏÑù Ï≤¥ÌÅ¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 500px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #f9ca24);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .autocomplete-detected {
            background-color: #d4edda !important;
            border-color: #28a745 !important;
        }

        .warning-message {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            display: none;
        }

        .error-message {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            display: none;
        }

        .success-message {
            background-color: #d1edff;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            display: none;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .submit-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .device-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 12px;
            color: #6c757d;
        }

        .timestamp {
            text-align: center;
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 20px;
        }

        .blocked-message {
            text-align: center;
            color: #e74c3c;
            font-size: 18px;
            font-weight: 600;
        }

        .manual-instruction {
            background: #e8f4f8;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .manual-instruction h3 {
            color: #17a2b8;
            margin-bottom: 10px;
        }

        .fingerprint-info {
            font-size: 10px;
            color: #adb5bd;
            margin-top: 10px;
            text-align: center;
        }

        .location-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .location-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(40, 167, 69, 0.3);
        }

        .location-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .location-btn.checking {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }

        .location-btn.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .location-btn.error {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .location-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .location-result {
            font-size: 14px;
            line-height: 1.5;
        }

        .location-success {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .location-error {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .coordinates-info {
            font-size: 12px;
            color: #6c757d;
            margin-top: 8px;
            font-family: monospace;
            background: #f1f3f4;
            padding: 8px;
            border-radius: 4px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 30px 20px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì ÏÑ∏ÎØ∏ÎÇòÏã§ Ï∂úÏÑù Ï≤¥ÌÅ¨</h1>
            <p>ÌñâÏÇ¨ Ï∞∏ÏÑù ÌôïÏù∏ÏùÑ ÏúÑÌï¥ Ï†ïÎ≥¥Î•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî</p>
        </div>

        <div id="attendanceForm">
            <form id="checkInForm">
                <div class="form-group">
                    <label for="name">Ïù¥Î¶Ñ *</label>
                    <input type="text" id="name" name="name" required autocomplete="name">
                </div>

                <div class="form-group">
                    <label for="affiliation">ÏÜåÏÜç *</label>
                    <input type="text" id="affiliation" name="affiliation" required autocomplete="organization">
                </div>

                <div class="form-group">
                    <label for="email">Ïù¥Î©îÏùº</label>
                    <input type="email" id="email" name="email" autocomplete="email">
                </div>

                <div class="form-group">
                    <label for="phone">Ïó∞ÎùΩÏ≤ò</label>
                    <input type="tel" id="phone" name="phone" autocomplete="tel">
                </div>

                <div class="form-group">
                    <label for="location">ÏúÑÏπò ÌôïÏù∏ *</label>
                    <div class="location-status" id="locationStatus">
                        <button type="button" class="location-btn" id="locationBtn">
                            üìç ÌòÑÏû¨ ÏúÑÏπò ÌôïÏù∏
                        </button>
                        <div class="location-info" id="locationInfo" style="display: none;">
                            <div class="location-result" id="locationResult"></div>
                        </div>
                    </div>
                    <input type="hidden" id="location" name="location" required>
                    <input type="hidden" id="coordinates" name="coordinates">
                </div>

                <div class="warning-message" id="warningMessage">
                    ‚ö†Ô∏è ÏûÖÎ†•ÌïòÏã† Ï†ïÎ≥¥ÏôÄ Î∏åÎùºÏö∞Ï†ÄÏóê Ï†ÄÏû•Îêú Ï†ïÎ≥¥Í∞Ä Îã§Î¶ÖÎãàÎã§. Ï†ïÌôïÌïú Ï†ïÎ≥¥Ïù∏ÏßÄ ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî.
                </div>

                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>

                <button type="submit" class="submit-btn" id="submitBtn">Ï∂úÏÑù Ï≤¥ÌÅ¨ ÏôÑÎ£å</button>
            </form>

            <div class="manual-instruction">
                <h3>üì± Ìú¥ÎåÄÌè∞ ÏÇ¨Ïö©Ïù¥ Ïñ¥Î†§Ïö∞Ïã† Í≤ΩÏö∞</h3>
                <p>ÌñâÏÇ¨Ïû• ÏïûÏ™ΩÏóê ÎπÑÏπòÎêú <strong>'Ï∞∏ÏÑùÏûê Î™ÖÎ∂Ä'</strong>Ïóê ÏßÅÏ†ë Í∏∞Ïû¨Ìï¥ Ï£ºÏãúÍ∏∞ Î∞îÎûçÎãàÎã§.</p>
            </div>

            <div class="device-info" id="deviceInfo"></div>
            <div class="fingerprint-info">
                Î≥¥ÏïàÏùÑ ÏúÑÌï¥ Í∏∞Í∏∞ Ï†ïÎ≥¥Î•º ÏàòÏßëÌï©ÎãàÎã§ (Ï§ëÎ≥µ Ï≤¥ÌÅ¨ Î∞©ÏßÄÏö©)
            </div>
        </div>

        <div id="blockedMessage" style="display: none;">
            <div class="blocked-message">
                <h2>üö´ Ïù¥ÎØ∏ Ï∂úÏÑù Ï≤¥ÌÅ¨ ÏôÑÎ£å</h2>
                <p>Ïù¥ Í∏∞Í∏∞ÏóêÏÑúÎäî Ïù¥ÎØ∏ Ï∂úÏÑù Ï≤¥ÌÅ¨Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.</p>
                <div class="manual-instruction">
                    <h3>Îã§Î•∏ Î∞©Î≤ïÏúºÎ°ú Ï∂úÏÑù Ï≤¥ÌÅ¨</h3>
                    <p>ÌñâÏÇ¨Ïû• ÏïûÏ™ΩÏóê ÎπÑÏπòÎêú <strong>'Ï∞∏ÏÑùÏûê Î™ÖÎ∂Ä'</strong>Ïóê ÏßÅÏ†ë Í∏∞Ïû¨Ìï¥ Ï£ºÏÑ∏Ïöî.</p>
                </div>
            </div>
        </div>

        <div class="timestamp" id="timestamp"></div>
    </div>

    <script>
        // Google Apps Script Ïõπ Ïï± URL - Ïã§Ï†ú URLÎ°ú Î≥ÄÍ≤ΩÌï¥Ïïº Ìï©ÎãàÎã§
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyL29TJ4He1nBjf_pco82hCMH1sLJlrXYjnOvmK7CJQeb69A065FNIbS7MdmzqbkvvIxw/exec';
        // ÌóàÏö©Îêú ÏúÑÏπò ÏÑ§Ï†ï (ÎåÄÌïôÍµê ÏÑ∏ÎØ∏ÎÇòÏã§ Ï¢åÌëú)
        const ALLOWED_LOCATIONS = [
           {
                name: "Îã®Ìò∏ÌôÄ",
                lat: 37.228848,    // Ïã§Ï†ú Ï¢åÌëúÎ°ú Î≥ÄÍ≤Ω ÌïÑÏöî
                lng: 127.167855,   // Ïã§Ï†ú Ï¢åÌëúÎ°ú Î≥ÄÍ≤Ω ÌïÑÏöî
                radius: 30      // ÌóàÏö© Î∞òÍ≤Ω (ÎØ∏ÌÑ∞)
            },
            {
                name: "Î≤ΩÏÜåÌôÄ",
                lat: 37.228767,    // Ïã§Ï†ú Ï¢åÌëúÎ°ú Î≥ÄÍ≤Ω ÌïÑÏöî
                lng: 127.167449,   // Ïã§Ï†ú Ï¢åÌëúÎ°ú Î≥ÄÍ≤Ω ÌïÑÏöî
                radius: 30      // ÌóàÏö© Î∞òÍ≤Ω (ÎØ∏ÌÑ∞)
            },
            {
                name: "ÎåÄÌïôÍµê Î≥∏Í¥Ä",
                lat: 37.227239,    // Ïã§Ï†ú Ï¢åÌëúÎ°ú Î≥ÄÍ≤Ω ÌïÑÏöî
                lng: 127.166598,   // Ïã§Ï†ú Ï¢åÌëúÎ°ú Î≥ÄÍ≤Ω ÌïÑÏöî
                radius: 30      // ÌóàÏö© Î∞òÍ≤Ω (ÎØ∏ÌÑ∞)
            }
        ];

        class AttendanceSystem {
            constructor() {
                this.deviceFingerprint = this.generateDeviceFingerprint();
                this.autocompleteData = {};
                this.currentLocation = null;
                this.locationVerified = false;
                this.init();
            }

            // ÎîîÎ∞îÏù¥Ïä§ ÌïëÍ±∞ÌîÑÎ¶∞ÌåÖ ÏÉùÏÑ±
            generateDeviceFingerprint() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillText('Device fingerprint', 2, 2);
                
                const fingerprint = {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    platform: navigator.platform,
                    screen: `${screen.width}x${screen.height}x${screen.colorDepth}`,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    canvas: canvas.toDataURL(),
                    cookieEnabled: navigator.cookieEnabled,
                    doNotTrack: navigator.doNotTrack,
                    hardwareConcurrency: navigator.hardwareConcurrency || 'unknown'
                };

                // Î™®Îì† Ï†ïÎ≥¥Î•º Ï°∞Ìï©ÌïòÏó¨ Ìï¥Ïãú ÏÉùÏÑ±
                const combined = JSON.stringify(fingerprint);
                return this.simpleHash(combined);
            }

            // Í∞ÑÎã®Ìïú Ìï¥Ïãú Ìï®Ïàò
            simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // 32bit integerÎ°ú Î≥ÄÌôò
                }
                return Math.abs(hash).toString(36);
            }

            // Ï¥àÍ∏∞Ìôî
            init() {
                this.updateTimestamp();
                this.displayDeviceInfo();
                this.checkIfBlocked();
                this.setupEventListeners();
                this.detectAutocomplete();
                
                setInterval(() => this.updateTimestamp(), 1000);
            }

            // Ï∞®Îã® Ïó¨Î∂Ä ÌôïÏù∏
            checkIfBlocked() {
                const sessionBlocked = sessionStorage.getItem('attendance_submitted');
                const deviceBlocked = localStorage.getItem(`attendance_${this.deviceFingerprint}`);
                
                if (sessionBlocked || deviceBlocked) {
                    document.getElementById('attendanceForm').style.display = 'none';
                    document.getElementById('blockedMessage').style.display = 'block';
                    return true;
                }
                return false;
            }

            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
            setupEventListeners() {
                const form = document.getElementById('checkInForm');
                const inputs = form.querySelectorAll('input[autocomplete]');

                // ÏûêÎèôÏôÑÏÑ± Í∞êÏßÄ
                inputs.forEach(input => {
                    input.addEventListener('input', () => this.checkAutocompleteMatch(input));
                    input.addEventListener('change', () => this.checkAutocompleteMatch(input));
                });

                // ÏúÑÏπò ÌôïÏù∏ Î≤ÑÌäº
                document.getElementById('locationBtn').addEventListener('click', () => this.checkLocation());

                // Ìèº Ï†úÏ∂ú
                form.addEventListener('submit', (e) => this.handleSubmit(e));
            }

            // ÏûêÎèôÏôÑÏÑ± Îç∞Ïù¥ÌÑ∞ Í∞êÏßÄ
            detectAutocomplete() {
                setTimeout(() => {
                    const inputs = document.querySelectorAll('input[autocomplete]');
                    inputs.forEach(input => {
                        if (input.value && input.value.trim() !== '') {
                            this.autocompleteData[input.name] = input.value.trim();
                            input.classList.add('autocomplete-detected');
                        }
                    });
                }, 1000);
            }

            // ÏûêÎèôÏôÑÏÑ± Îß§Ïπò ÌôïÏù∏
            checkAutocompleteMatch(input) {
                const fieldName = input.name;
                const currentValue = input.value.trim();
                const autocompleteValue = this.autocompleteData[fieldName];

                if (autocompleteValue && currentValue && 
                    currentValue.toLowerCase() !== autocompleteValue.toLowerCase()) {
                    this.showWarning();
                } else {
                    this.hideWarning();
                }
            }

            // Í≤ΩÍ≥† Î©îÏãúÏßÄ ÌëúÏãú
            showWarning() {
                document.getElementById('warningMessage').style.display = 'block';
            }

            // Í≤ΩÍ≥† Î©îÏãúÏßÄ Ïà®ÍπÄ
            hideWarning() {
                document.getElementById('warningMessage').style.display = 'none';
            }

            // ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú
            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }

            // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
            showSuccess(message) {
                const successDiv = document.getElementById('successMessage');
                successDiv.textContent = message;
                successDiv.style.display = 'block';
            }

            // GPS ÏúÑÏπò ÌôïÏù∏
            async checkLocation() {
                const locationBtn = document.getElementById('locationBtn');
                const locationInfo = document.getElementById('locationInfo');
                const locationResult = document.getElementById('locationResult');

                locationBtn.disabled = true;
                locationBtn.className = 'location-btn checking';
                locationBtn.innerHTML = 'üîÑ ÏúÑÏπò ÌôïÏù∏ Ï§ë...';

                try {
                    // ÏúÑÏπò Í∂åÌïú ÌôïÏù∏
                    if (!navigator.geolocation) {
                        throw new Error('GPS Í∏∞Îä•ÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÎäî Î∏åÎùºÏö∞Ï†ÄÏûÖÎãàÎã§.');
                    }

                    // GPS ÏúÑÏπò Í∞ÄÏ†∏Ïò§Í∏∞
                    const position = await this.getCurrentPosition();
                    const { latitude, longitude } = position.coords;

                    // ÌóàÏö©Îêú ÏúÑÏπòÏù∏ÏßÄ ÌôïÏù∏
                    const allowedLocation = this.isLocationAllowed(latitude, longitude);

                    if (allowedLocation) {
                        this.locationVerified = true;
                        this.currentLocation = {
                            lat: latitude,
                            lng: longitude,
                            name: allowedLocation.name,
                            distance: allowedLocation.distance
                        };

                        // ÏÑ±Í≥µ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                        locationBtn.className = 'location-btn success';
                        locationBtn.innerHTML = '‚úÖ ÏúÑÏπò ÌôïÏù∏ ÏôÑÎ£å';
                        
                        locationResult.innerHTML = `
                            <div class="location-success">
                                <strong>‚úÖ ÏúÑÏπò ÌôïÏù∏ ÏÑ±Í≥µ!</strong><br>
                                ÌòÑÏû¨ ÏúÑÏπò: ${allowedLocation.name}<br>
                                Í±∞Î¶¨: ÏïΩ ${Math.round(allowedLocation.distance)}m
                            </div>
                            <div class="coordinates-info">
                                Ï¢åÌëú: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}
                            </div>
                        `;

                        // Ïà®Í≤®ÏßÑ ÌïÑÎìúÏóê ÏúÑÏπò Ï†ïÎ≥¥ Ï†ÄÏû•
                        document.getElementById('location').value = allowedLocation.name;
                        document.getElementById('coordinates').value = `${latitude},${longitude}`;

                    } else {
                        throw new Error('ÌóàÏö©Îêú ÏúÑÏπòÍ∞Ä ÏïÑÎãôÎãàÎã§. ÏÑ∏ÎØ∏ÎÇòÏã§ ÎÇ¥Î∂ÄÏóêÏÑú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.');
                    }

                    locationInfo.style.display = 'block';

                } catch (error) {
                    console.error('ÏúÑÏπò ÌôïÏù∏ Ïò§Î•ò:', error);
                    
                    locationBtn.className = 'location-btn error';
                    locationBtn.innerHTML = '‚ùå ÏúÑÏπò ÌôïÏù∏ Ïã§Ìå®';
                    
                    locationResult.innerHTML = `
                        <div class="location-error">
                            <strong>‚ùå ÏúÑÏπò ÌôïÏù∏ Ïã§Ìå®</strong><br>
                            ${error.message}<br><br>
                            <small style="font-size: 12px;">
                                ‚Ä¢ GPS Í∂åÌïúÏùÑ ÌóàÏö©Ìï¥ Ï£ºÏÑ∏Ïöî<br>
                                ‚Ä¢ ÏÑ∏ÎØ∏ÎÇòÏã§ ÎÇ¥Î∂ÄÏóêÏÑú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî<br>
                                ‚Ä¢ WiFiÏôÄ ÏúÑÏπò ÏÑúÎπÑÏä§Î•º ÏºúÏ£ºÏÑ∏Ïöî
                            </small>
                        </div>
                    `;
                    
                    locationInfo.style.display = 'block';
                    this.locationVerified = false;
                }

                // Î≤ÑÌäº Ïû¨ÌôúÏÑ±Ìôî
                setTimeout(() => {
                    locationBtn.disabled = false;
                    if (!this.locationVerified) {
                        locationBtn.className = 'location-btn';
                        locationBtn.innerHTML = 'üìç ÏúÑÏπò Îã§Ïãú ÌôïÏù∏';
                    }
                }, 3000);
            }

            // ÌòÑÏû¨ ÏúÑÏπò Í∞ÄÏ†∏Ïò§Í∏∞ (Promise ÎûòÌçº)
            getCurrentPosition() {
                return new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        resolve,
                        reject,
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 60000
                        }
                    );
                });
            }

            // ÌóàÏö©Îêú ÏúÑÏπòÏù∏ÏßÄ ÌôïÏù∏
            isLocationAllowed(lat, lng) {
                for (const location of ALLOWED_LOCATIONS) {
                    const distance = this.calculateDistance(lat, lng, location.lat, location.lng);
                    if (distance <= location.radius) {
                        return {
                            name: location.name,
                            distance: distance
                        };
                    }
                }
                return null;
            }

            // Îëê Ï¢åÌëú Í∞ÑÏùò Í±∞Î¶¨ Í≥ÑÏÇ∞ (ÎØ∏ÌÑ∞)
            calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371e3; // ÏßÄÍµ¨ Î∞òÂæÑ (ÎØ∏ÌÑ∞)
                const œÜ1 = lat1 * Math.PI/180;
                const œÜ2 = lat2 * Math.PI/180;
                const ŒîœÜ = (lat2-lat1) * Math.PI/180;
                const ŒîŒª = (lng2-lng1) * Math.PI/180;

                const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                        Math.cos(œÜ1) * Math.cos(œÜ2) *
                        Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                return R * c; // Í±∞Î¶¨ (ÎØ∏ÌÑ∞)
            }

            // Ìèº Ï†úÏ∂ú Ï≤òÎ¶¨
            async handleSubmit(e) {
                e.preventDefault();
                
                if (this.checkIfBlocked()) {
                    return;
                }

                const formData = new FormData(e.target);
                const submitBtn = document.getElementById('submitBtn');
                
                // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
                submitBtn.disabled = true;
                submitBtn.textContent = 'Ï†úÏ∂ú Ï§ë...';

                try {
                    // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
                    if (!this.validateForm(formData)) {
                        return;
                    }

                    // Íµ¨Í∏Ä ÏãúÌä∏Ïóê Îç∞Ïù¥ÌÑ∞ Ï†úÏ∂ú
                    await this.submitToGoogleSheets(formData);

                    // ÏÑ±Í≥µ Ï≤òÎ¶¨
                    this.markAsSubmitted();
                    this.showSuccess('‚úÖ Ï∂úÏÑù Ï≤¥ÌÅ¨Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!');
                    
                    // Ìèº Ïà®Í∏∞Í∏∞
                    setTimeout(() => {
                        document.getElementById('attendanceForm').style.display = 'none';
                        document.getElementById('blockedMessage').style.display = 'block';
                    }, 2000);

                } catch (error) {
                    console.error('Ï†úÏ∂ú Ïò§Î•ò:', error);
                    this.showError('‚ùå Ï†úÏ∂ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Ï∂úÏÑù Ï≤¥ÌÅ¨ ÏôÑÎ£å';
                }
            }

            // Ìèº Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
            validateForm(formData) {
                const name = formData.get('name');
                const affiliation = formData.get('affiliation');
                const location = formData.get('location');

                if (!name || !affiliation) {
                    this.showError('ÌïÑÏàò Ìï≠Î™©ÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.');
                    return false;
                }

                if (!this.locationVerified || !location) {
                    this.showError('GPS ÏúÑÏπò ÌôïÏù∏ÏùÑ Î®ºÏ†Ä ÏôÑÎ£åÌï¥ Ï£ºÏÑ∏Ïöî.');
                    return false;
                }

                return true;
            }

            // Íµ¨Í∏Ä ÌèºÏóê Îç∞Ïù¥ÌÑ∞ Ï†úÏ∂ú
            async submitToGoogleForm(formData) {
                const submitData = new FormData();
                
                // Íµ¨Í∏Ä Ìèº ÌïÑÎìúÏóê Îß§Ìïë
                submitData.append(FORM_FIELDS.name, formData.get('name'));
                submitData.append(FORM_FIELDS.affiliation, formData.get('affiliation'));
                submitData.append(FORM_FIELDS.email, formData.get('email') || '');
                submitData.append(FORM_FIELDS.phone, formData.get('phone') || '');
                submitData.append(FORM_FIELDS.location, formData.get('location'));
                submitData.append(FORM_FIELDS.coordinates, formData.get('coordinates') || '');
                submitData.append(FORM_FIELDS.timestamp, new Date().toLocaleString('ko-KR'));
                submitData.append(FORM_FIELDS.deviceId, this.deviceFingerprint);

                // CORS Ïö∞ÌöåÎ•º ÏúÑÌïú fetch ÏöîÏ≤≠
                const response = await fetch(GOOGLE_FORM_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: submitData
                });

                // no-cors Î™®ÎìúÏóêÏÑúÎäî ÏùëÎãµÏùÑ ÌôïÏù∏Ìï† Ïàò ÏóÜÏúºÎØÄÎ°ú ÏÑ±Í≥µÏúºÎ°ú Í∞ÑÏ£º
                return Promise.resolve();
            }

            // Ï†úÏ∂ú ÏôÑÎ£å ÌëúÏãú
            markAsSubmitted() {
                sessionStorage.setItem('attendance_submitted', 'true');
                localStorage.setItem(`attendance_${this.deviceFingerprint}`, Date.now().toString());
                
                // Ïø†ÌÇ§Î°úÎèÑ Ï†ÄÏû• (Ï∂îÍ∞Ä Î≥¥Ïïà)
                document.cookie = `attendance_${this.deviceFingerprint}=submitted; max-age=${30*24*60*60}; path=/`;
            }

            // ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏
            updateTimestamp() {
                const now = new Date();
                const timeString = now.toLocaleString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    weekday: 'short'
                });
                document.getElementById('timestamp').textContent = `ÌòÑÏû¨ ÏãúÍ∞Ñ: ${timeString}`;
            }

            // ÎîîÎ∞îÏù¥Ïä§ Ï†ïÎ≥¥ ÌëúÏãú
            displayDeviceInfo() {
                const deviceInfo = document.getElementById('deviceInfo');
                deviceInfo.innerHTML = `
                    <strong>Í∏∞Í∏∞ Ï†ïÎ≥¥:</strong><br>
                    Î∏åÎùºÏö∞Ï†Ä: ${navigator.userAgent.split(' ')[0]}<br>
                    ÌôîÎ©¥: ${screen.width}√ó${screen.height}<br>
                    Ïñ∏Ïñ¥: ${navigator.language}<br>
                    Í∏∞Í∏∞ ID: ${this.deviceFingerprint.substring(0, 8)}...
                `;
            }
        }

        // ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', () => {
            new AttendanceSystem();
        });
    </script>
</body>
</html>
