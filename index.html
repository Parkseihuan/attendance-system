<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„¸ë¯¸ë‚˜ì‹¤ ì¶œì„ ì²´í¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 500px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #f9ca24);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .autocomplete-detected {
            background-color: #d4edda !important;
            border-color: #28a745 !important;
        }

        .warning-message {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            display: none;
        }

        .error-message {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            display: none;
        }

        .success-message {
            background-color: #d1edff;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            display: none;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .submit-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .device-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 12px;
            color: #6c757d;
        }

        .timestamp {
            text-align: center;
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 20px;
        }

        .blocked-message {
            text-align: center;
            color: #e74c3c;
            font-size: 18px;
            font-weight: 600;
        }

        .manual-instruction {
            background: #e8f4f8;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .manual-instruction h3 {
            color: #17a2b8;
            margin-bottom: 10px;
        }

        .fingerprint-info {
            font-size: 10px;
            color: #adb5bd;
            margin-top: 10px;
            text-align: center;
        }

        .location-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .location-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(40, 167, 69, 0.3);
        }

        .location-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .location-btn.checking {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }

        .location-btn.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .location-btn.error {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .location-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .location-result {
            font-size: 14px;
            line-height: 1.5;
        }

        .location-success {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .location-error {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .coordinates-info {
            font-size: 12px;
            color: #6c757d;
            margin-top: 8px;
            font-family: monospace;
            background: #f1f3f4;
            padding: 8px;
            border-radius: 4px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 30px 20px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ ì„¸ë¯¸ë‚˜ì‹¤ ì¶œì„ ì²´í¬</h1>
            <p>í–‰ì‚¬ ì°¸ì„ í™•ì¸ì„ ìœ„í•´ ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”</p>
        </div>

        <div id="attendanceForm">
            <form id="checkInForm">
                <div class="form-group">
                    <label for="name">ì´ë¦„ *</label>
                    <input type="text" id="name" name="name" required autocomplete="name">
                </div>

                <div class="form-group">
                    <label for="affiliation">ì†Œì† *</label>
                    <input type="text" id="affiliation" name="affiliation" required autocomplete="organization">
                </div>

                <div class="form-group">
                    <label for="email">ì´ë©”ì¼</label>
                    <input type="email" id="email" name="email" autocomplete="email">
                </div>

                <div class="form-group">
                    <label for="phone">ì—°ë½ì²˜</label>
                    <input type="tel" id="phone" name="phone" autocomplete="tel">
                </div>

                <div class="form-group">
                    <label for="location">ìœ„ì¹˜ í™•ì¸ *</label>
                    <div class="location-status" id="locationStatus">
                        <button type="button" class="location-btn" id="locationBtn">
                            ğŸ“ í˜„ì¬ ìœ„ì¹˜ í™•ì¸
                        </button>
                        <div class="location-info" id="locationInfo" style="display: none;">
                            <div class="location-result" id="locationResult"></div>
                        </div>
                    </div>
                    <input type="hidden" id="location" name="location" required>
                    <input type="hidden" id="coordinates" name="coordinates">
                </div>

                <div class="warning-message" id="warningMessage">
                    âš ï¸ ì…ë ¥í•˜ì‹  ì •ë³´ì™€ ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ì •ë³´ê°€ ë‹¤ë¦…ë‹ˆë‹¤. ì •í™•í•œ ì •ë³´ì¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.
                </div>

                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>

                <button type="submit" class="submit-btn" id="submitBtn">ì¶œì„ ì²´í¬ ì™„ë£Œ</button>
            </form>

            <div class="manual-instruction">
                <h3>ğŸ“± íœ´ëŒ€í° ì‚¬ìš©ì´ ì–´ë ¤ìš°ì‹  ê²½ìš°</h3>
                <p>í–‰ì‚¬ì¥ ì•ìª½ì— ë¹„ì¹˜ëœ <strong>'ì°¸ì„ì ëª…ë¶€'</strong>ì— ì§ì ‘ ê¸°ì¬í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
            </div>

            <div class="device-info" id="deviceInfo"></div>
            <div class="fingerprint-info">
                ë³´ì•ˆì„ ìœ„í•´ ê¸°ê¸° ì •ë³´ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤ (ì¤‘ë³µ ì²´í¬ ë°©ì§€ìš©)
            </div>
        </div>

        <div id="blockedMessage" style="display: none;">
            <div class="blocked-message">
                <h2>ğŸš« ì´ë¯¸ ì¶œì„ ì²´í¬ ì™„ë£Œ</h2>
                <p>ì´ ê¸°ê¸°ì—ì„œëŠ” ì´ë¯¸ ì¶œì„ ì²´í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                <div class="manual-instruction">
                    <h3>ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ì¶œì„ ì²´í¬</h3>
                    <p>í–‰ì‚¬ì¥ ì•ìª½ì— ë¹„ì¹˜ëœ <strong>'ì°¸ì„ì ëª…ë¶€'</strong>ì— ì§ì ‘ ê¸°ì¬í•´ ì£¼ì„¸ìš”.</p>
                </div>
            </div>
        </div>

        <div class="timestamp" id="timestamp"></div>
    </div>

    <script>
        // Google Apps Script ì›¹ ì•± URL - ì‹¤ì œ URLë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyL29TJ4He1nBjf_pco82hCMH1sLJlrXYjnOvmK7CJQeb69A065FNIbS7MdmzqbkvvIxw/exec';
        // í—ˆìš©ëœ ìœ„ì¹˜ ì„¤ì • (ëŒ€í•™êµ ì„¸ë¯¸ë‚˜ì‹¤ ì¢Œí‘œ)
        const ALLOWED_LOCATIONS = [
           {
                name: "ë‹¨í˜¸í™€",
                lat: 37.228848,    // ì‹¤ì œ ì¢Œí‘œë¡œ ë³€ê²½ í•„ìš”
                lng: 127.167855,   // ì‹¤ì œ ì¢Œí‘œë¡œ ë³€ê²½ í•„ìš”
                radius: 30      // í—ˆìš© ë°˜ê²½ (ë¯¸í„°)
            },
            {
                name: "ë²½ì†Œí™€",
                lat: 37.228767,    // ì‹¤ì œ ì¢Œí‘œë¡œ ë³€ê²½ í•„ìš”
                lng: 127.167449,   // ì‹¤ì œ ì¢Œí‘œë¡œ ë³€ê²½ í•„ìš”
                radius: 30      // í—ˆìš© ë°˜ê²½ (ë¯¸í„°)
            },
            {
                name: "ëŒ€í•™êµ ë³¸ê´€",
                lat: 37.227239,    // ì‹¤ì œ ì¢Œí‘œë¡œ ë³€ê²½ í•„ìš”
                lng: 127.166598,   // ì‹¤ì œ ì¢Œí‘œë¡œ ë³€ê²½ í•„ìš”
                radius: 30      // í—ˆìš© ë°˜ê²½ (ë¯¸í„°)
            }
        ];

        class AttendanceSystem {
            constructor() {
                this.deviceFingerprint = this.generateDeviceFingerprint();
                this.autocompleteData = {};
                this.currentLocation = null;
                this.locationVerified = false;
                this.init();
            }

            // ë””ë°”ì´ìŠ¤ í•‘ê±°í”„ë¦°íŒ… ìƒì„±
            generateDeviceFingerprint() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillText('Device fingerprint', 2, 2);
                
                const fingerprint = {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    platform: navigator.platform,
                    screen: `${screen.width}x${screen.height}x${screen.colorDepth}`,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    canvas: canvas.toDataURL(),
                    cookieEnabled: navigator.cookieEnabled,
                    doNotTrack: navigator.doNotTrack,
                    hardwareConcurrency: navigator.hardwareConcurrency || 'unknown'
                };

                // ëª¨ë“  ì •ë³´ë¥¼ ì¡°í•©í•˜ì—¬ í•´ì‹œ ìƒì„±
                const combined = JSON.stringify(fingerprint);
                return this.simpleHash(combined);
            }

            // ê°„ë‹¨í•œ í•´ì‹œ í•¨ìˆ˜
            simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // 32bit integerë¡œ ë³€í™˜
                }
                return Math.abs(hash).toString(36);
            }

            // ì´ˆê¸°í™”
            init() {
                this.updateTimestamp();
                this.displayDeviceInfo();
                this.checkIfBlocked();
                this.setupEventListeners();
                this.detectAutocomplete();
                
                setInterval(() => this.updateTimestamp(), 1000);
            }

            // ì°¨ë‹¨ ì—¬ë¶€ í™•ì¸
            checkIfBlocked() {
                const sessionBlocked = sessionStorage.getItem('attendance_submitted');
                const deviceBlocked = localStorage.getItem(`attendance_${this.deviceFingerprint}`);
                
                if (sessionBlocked || deviceBlocked) {
                    document.getElementById('attendanceForm').style.display = 'none';
                    document.getElementById('blockedMessage').style.display = 'block';
                    return true;
                }
                return false;
            }

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupEventListeners() {
                const form = document.getElementById('checkInForm');
                const inputs = form.querySelectorAll('input[autocomplete]');

                // ìë™ì™„ì„± ê°ì§€
                inputs.forEach(input => {
                    input.addEventListener('input', () => this.checkAutocompleteMatch(input));
                    input.addEventListener('change', () => this.checkAutocompleteMatch(input));
                });

                // ìœ„ì¹˜ í™•ì¸ ë²„íŠ¼
                document.getElementById('locationBtn').addEventListener('click', () => this.checkLocation());

                // í¼ ì œì¶œ
                form.addEventListener('submit', (e) => this.handleSubmit(e));
            }

            // ìë™ì™„ì„± ë°ì´í„° ê°ì§€
            detectAutocomplete() {
                setTimeout(() => {
                    const inputs = document.querySelectorAll('input[autocomplete]');
                    inputs.forEach(input => {
                        if (input.value && input.value.trim() !== '') {
                            this.autocompleteData[input.name] = input.value.trim();
                            input.classList.add('autocomplete-detected');
                        }
                    });
                }, 1000);
            }

            // ìë™ì™„ì„± ë§¤ì¹˜ í™•ì¸
            checkAutocompleteMatch(input) {
                const fieldName = input.name;
                const currentValue = input.value.trim();
                const autocompleteValue = this.autocompleteData[fieldName];

                if (autocompleteValue && currentValue && 
                    currentValue.toLowerCase() !== autocompleteValue.toLowerCase()) {
                    this.showWarning();
                } else {
                    this.hideWarning();
                }
            }

            // ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
            showWarning() {
                document.getElementById('warningMessage').style.display = 'block';
            }

            // ê²½ê³  ë©”ì‹œì§€ ìˆ¨ê¹€
            hideWarning() {
                document.getElementById('warningMessage').style.display = 'none';
            }

            // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }

            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            showSuccess(message) {
                const successDiv = document.getElementById('successMessage');
                successDiv.textContent = message;
                successDiv.style.display = 'block';
            }

            // GPS ìœ„ì¹˜ í™•ì¸
            async checkLocation() {
                const locationBtn = document.getElementById('locationBtn');
                const locationInfo = document.getElementById('locationInfo');
                const locationResult = document.getElementById('locationResult');

                locationBtn.disabled = true;
                locationBtn.className = 'location-btn checking';
                locationBtn.innerHTML = 'ğŸ”„ ìœ„ì¹˜ í™•ì¸ ì¤‘...';

                try {
                    // ìœ„ì¹˜ ê¶Œí•œ í™•ì¸
                    if (!navigator.geolocation) {
                        throw new Error('GPS ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
                    }

                    // GPS ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
                    const position = await this.getCurrentPosition();
                    const { latitude, longitude } = position.coords;

                    // í—ˆìš©ëœ ìœ„ì¹˜ì¸ì§€ í™•ì¸
                    const allowedLocation = this.isLocationAllowed(latitude, longitude);

                    if (allowedLocation) {
                        this.locationVerified = true;
                        this.currentLocation = {
                            lat: latitude,
                            lng: longitude,
                            name: allowedLocation.name,
                            distance: allowedLocation.distance
                        };

                        // ì„±ê³µ ìƒíƒœ ì—…ë°ì´íŠ¸
                        locationBtn.className = 'location-btn success';
                        locationBtn.innerHTML = 'âœ… ìœ„ì¹˜ í™•ì¸ ì™„ë£Œ';
                        
                        locationResult.innerHTML = `
                            <div class="location-success">
                                <strong>âœ… ìœ„ì¹˜ í™•ì¸ ì„±ê³µ!</strong><br>
                                í˜„ì¬ ìœ„ì¹˜: ${allowedLocation.name}<br>
                                ê±°ë¦¬: ì•½ ${Math.round(allowedLocation.distance)}m
                            </div>
                            <div class="coordinates-info">
                                ì¢Œí‘œ: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}
                            </div>
                        `;

                        // ìˆ¨ê²¨ì§„ í•„ë“œì— ìœ„ì¹˜ ì •ë³´ ì €ì¥
                        document.getElementById('location').value = allowedLocation.name;
                        document.getElementById('coordinates').value = `${latitude},${longitude}`;

                    } else {
                        throw new Error('í—ˆìš©ëœ ìœ„ì¹˜ê°€ ì•„ë‹™ë‹ˆë‹¤. ì„¸ë¯¸ë‚˜ì‹¤ ë‚´ë¶€ì—ì„œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                    }

                    locationInfo.style.display = 'block';

                } catch (error) {
                    console.error('ìœ„ì¹˜ í™•ì¸ ì˜¤ë¥˜:', error);
                    
                    locationBtn.className = 'location-btn error';
                    locationBtn.innerHTML = 'âŒ ìœ„ì¹˜ í™•ì¸ ì‹¤íŒ¨';
                    
                    locationResult.innerHTML = `
                        <div class="location-error">
                            <strong>âŒ ìœ„ì¹˜ í™•ì¸ ì‹¤íŒ¨</strong><br>
                            ${error.message}<br><br>
                            <small style="font-size: 12px;">
                                â€¢ GPS ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”<br>
                                â€¢ ì„¸ë¯¸ë‚˜ì‹¤ ë‚´ë¶€ì—ì„œ ì‹œë„í•´ ì£¼ì„¸ìš”<br>
                                â€¢ WiFiì™€ ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì¼œì£¼ì„¸ìš”
                            </small>
                        </div>
                    `;
                    
                    locationInfo.style.display = 'block';
                    this.locationVerified = false;
                }

                // ë²„íŠ¼ ì¬í™œì„±í™”
                setTimeout(() => {
                    locationBtn.disabled = false;
                    if (!this.locationVerified) {
                        locationBtn.className = 'location-btn';
                        locationBtn.innerHTML = 'ğŸ“ ìœ„ì¹˜ ë‹¤ì‹œ í™•ì¸';
                    }
                }, 3000);
            }

            // í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° (Promise ë˜í¼)
            getCurrentPosition() {
                return new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        resolve,
                        reject,
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 60000
                        }
                    );
                });
            }

            // í—ˆìš©ëœ ìœ„ì¹˜ì¸ì§€ í™•ì¸
            isLocationAllowed(lat, lng) {
                for (const location of ALLOWED_LOCATIONS) {
                    const distance = this.calculateDistance(lat, lng, location.lat, location.lng);
                    if (distance <= location.radius) {
                        return {
                            name: location.name,
                            distance: distance
                        };
                    }
                }
                return null;
            }

            // ë‘ ì¢Œí‘œ ê°„ì˜ ê±°ë¦¬ ê³„ì‚° (ë¯¸í„°)
            calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371e3; // ì§€êµ¬ ë°˜å¾„ (ë¯¸í„°)
                const Ï†1 = lat1 * Math.PI/180;
                const Ï†2 = lat2 * Math.PI/180;
                const Î”Ï† = (lat2-lat1) * Math.PI/180;
                const Î”Î» = (lng2-lng1) * Math.PI/180;

                const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                        Math.cos(Ï†1) * Math.cos(Ï†2) *
                        Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                return R * c; // ê±°ë¦¬ (ë¯¸í„°)
            }

            // í¼ ì œì¶œ ì²˜ë¦¬
            async handleSubmit(e) {
                e.preventDefault();
                
                if (this.checkIfBlocked()) {
                    return;
                }

                const formData = new FormData(e.target);
                const submitBtn = document.getElementById('submitBtn');
                
                // ë²„íŠ¼ ë¹„í™œì„±í™”
                submitBtn.disabled = true;
                submitBtn.textContent = 'ì œì¶œ ì¤‘...';

                try {
                    // ìœ íš¨ì„± ê²€ì‚¬
                    if (!this.validateForm(formData)) {
                        return;
                    }

                    // êµ¬ê¸€ ì‹œíŠ¸ì— ë°ì´í„° ì œì¶œ
                    await this.submitToGoogleSheets(formData);

                    // ì„±ê³µ ì²˜ë¦¬
                    this.markAsSubmitted();
                    this.showSuccess('âœ… ì¶œì„ ì²´í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    
                    // í¼ ìˆ¨ê¸°ê¸°
                    setTimeout(() => {
                        document.getElementById('attendanceForm').style.display = 'none';
                        document.getElementById('blockedMessage').style.display = 'block';
                    }, 2000);

                } catch (error) {
                    console.error('ì œì¶œ ì˜¤ë¥˜:', error);
                    this.showError('âŒ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ì¶œì„ ì²´í¬ ì™„ë£Œ';
                }
            }

            // í¼ ìœ íš¨ì„± ê²€ì‚¬
            validateForm(formData) {
                const name = formData.get('name');
                const affiliation = formData.get('affiliation');
                const location = formData.get('location');

                if (!name || !affiliation) {
                    this.showError('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                    return false;
                }

                if (!this.locationVerified || !location) {
                    this.showError('GPS ìœ„ì¹˜ í™•ì¸ì„ ë¨¼ì € ì™„ë£Œí•´ ì£¼ì„¸ìš”.');
                    return false;
                }

                return true;
            }

            // êµ¬ê¸€ í¼ì— ë°ì´í„° ì œì¶œ
            async submitToGoogleForm(formData) {
                const submitData = new FormData();
                
                // êµ¬ê¸€ í¼ í•„ë“œì— ë§¤í•‘
                submitData.append(FORM_FIELDS.name, formData.get('name'));
                submitData.append(FORM_FIELDS.affiliation, formData.get('affiliation'));
                submitData.append(FORM_FIELDS.email, formData.get('email') || '');
                submitData.append(FORM_FIELDS.phone, formData.get('phone') || '');
                submitData.append(FORM_FIELDS.location, formData.get('location'));
                submitData.append(FORM_FIELDS.coordinates, formData.get('coordinates') || '');
                submitData.append(FORM_FIELDS.timestamp, new Date().toLocaleString('ko-KR'));
                submitData.append(FORM_FIELDS.deviceId, this.deviceFingerprint);

                // CORS ìš°íšŒë¥¼ ìœ„í•œ fetch ìš”ì²­
                const response = await fetch(GOOGLE_FORM_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: submitData
                });

                // no-cors ëª¨ë“œì—ì„œëŠ” ì‘ë‹µì„ í™•ì¸í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì„±ê³µìœ¼ë¡œ ê°„ì£¼
                return Promise.resolve();
            }

            // ì œì¶œ ì™„ë£Œ í‘œì‹œ
            markAsSubmitted() {
                sessionStorage.setItem('attendance_submitted', 'true');
                localStorage.setItem(`attendance_${this.deviceFingerprint}`, Date.now().toString());
                
                // ì¿ í‚¤ë¡œë„ ì €ì¥ (ì¶”ê°€ ë³´ì•ˆ)
                document.cookie = `attendance_${this.deviceFingerprint}=submitted; max-age=${30*24*60*60}; path=/`;
            }

            // íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸
            updateTimestamp() {
                const now = new Date();
                const timeString = now.toLocaleString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    weekday: 'short'
                });
                document.getElementById('timestamp').textContent = `í˜„ì¬ ì‹œê°„: ${timeString}`;
            }

            // ë””ë°”ì´ìŠ¤ ì •ë³´ í‘œì‹œ
            displayDeviceInfo() {
                const deviceInfo = document.getElementById('deviceInfo');
                deviceInfo.innerHTML = `
                    <strong>ê¸°ê¸° ì •ë³´:</strong><br>
                    ë¸Œë¼ìš°ì €: ${navigator.userAgent.split(' ')[0]}<br>
                    í™”ë©´: ${screen.width}Ã—${screen.height}<br>
                    ì–¸ì–´: ${navigator.language}<br>
                    ê¸°ê¸° ID: ${this.deviceFingerprint.substring(0, 8)}...
                `;
            }
        }

        // ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            new AttendanceSystem();
        });
    </script>
</body>
</html>
