<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„¸ë¯¸ë‚˜ì‹¤ ì¶œì„ ì²´í¬</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 500px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #f9ca24);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .submit-btn, .location-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .location-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            margin-bottom: 15px;
            margin-top: 0;
        }

        .submit-btn:hover:not(:disabled), .location-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .submit-btn:disabled, .location-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .location-btn.checking {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }

        .location-btn.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .location-btn.error {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .location-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            font-size: 14px;
            line-height: 1.5;
        }

        .location-success {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .location-error {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .manual-instruction {
            background: #e8f4f8;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .manual-instruction h3 {
            color: #17a2b8;
            margin-bottom: 10px;
        }

        .blocked-message {
            text-align: center;
            color: #e74c3c;
            font-size: 18px;
            font-weight: 600;
        }

        .device-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 12px;
            color: #6c757d;
        }

        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .mobile-buttons {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .mobile-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        .mobile-btn.refresh { background: #ff6b6b; }
        .mobile-btn.diagnose { background: #007bff; }

        @media (max-width: 600px) {
            .container {
                padding: 30px 20px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container rounded-xl">
        <div class="header">
            <h1 id="eventTitle">ğŸ“ ì„¸ë¯¸ë‚˜ì‹¤ ì¶œì„ ì²´í¬</h1>
            <p id="eventDescription">í–‰ì‚¬ ì°¸ì„ í™•ì¸ì„ ìœ„í•´ ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”</p>
        </div>

        <div id="attendanceForm">
            <form id="checkInForm">
                <div class="form-group">
                    <label for="name">ì´ë¦„ *</label>
                    <input type="text" id="name" name="name" required autocomplete="name" class="rounded-lg">
                </div>

                <div class="form-group">
                    <label for="affiliation">ì†Œì† *</label>
                    <input type="text" id="affiliation" name="affiliation" required autocomplete="organization" class="rounded-lg">
                </div>

                <div class="form-group">
                    <label for="email">ì´ë©”ì¼</label>
                    <input type="email" id="email" name="email" autocomplete="email" class="rounded-lg">
                </div>

                <div class="form-group">
                    <label for="phone">ì—°ë½ì²˜</label>
                    <input type="tel" id="phone" name="phone" autocomplete="tel" class="rounded-lg">
                </div>

                <div class="form-group">
                    <label for="location">ìœ„ì¹˜ í™•ì¸ *</label>
                    <div class="location-status" id="locationStatus">
                        <button type="button" class="location-btn rounded-lg" id="locationBtn">
                            ğŸ“ í˜„ì¬ ìœ„ì¹˜ í™•ì¸
                        </button>
                        <div class="location-info rounded-lg" id="locationInfo" style="display: none;">
                            <div class="location-result" id="locationResult"></div>
                        </div>
                    </div>
                    <input type="hidden" id="location" name="location" required>
                    <input type="hidden" id="coordinates" name="coordinates">
                </div>

                <button type="submit" class="submit-btn rounded-lg" id="submitBtn">ì¶œì„ ì²´í¬ ì™„ë£Œ</button>
            </form>

            <div class="manual-instruction rounded-r-lg" id="manualInstructionBox">
                <h3>ğŸ“± íœ´ëŒ€í° ì‚¬ìš©ì´ ì–´ë ¤ìš°ì‹  ê²½ìš°</h3>
                <p id="manualInstructionText">í–‰ì‚¬ì¥ ì•ìª½ì— ë¹„ì¹˜ëœ <strong>'ì°¸ì„ì ëª…ë¶€'</strong>ì— ì§ì ‘ ê¸°ì¬í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
            </div>

            <div class="device-info rounded-lg" id="deviceInfo"></div>
            
            <div class="debug-panel" id="debugPanel" style="display: none;">
                <div><strong>ğŸ” ì„¤ì • ìƒíƒœ í™•ì¸:</strong></div>
                <div id="debugContent"></div>
                <button type="button" onclick="toggleDebug()" style="margin-top: 10px; padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 11px;">
                    ë””ë²„ê·¸ ìˆ¨ê¸°ê¸°
                </button>
            </div>
        </div>

        <div id="blockedMessage" style="display: none;">
            <div class="blocked-message">
                <h2>ğŸš« ì´ë¯¸ ì¶œì„ ì²´í¬ ì™„ë£Œ</h2>
                <p>ì´ ê¸°ê¸°ì—ì„œëŠ” ì´ë¯¸ ì¶œì„ ì²´í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                <div class="manual-instruction rounded-r-lg">
                    <h3>ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ì¶œì„ ì²´í¬</h3>
                    <p id="blockedManualInstructionText">í–‰ì‚¬ì¥ ì•ìª½ì— ë¹„ì¹˜ëœ <strong>'ì°¸ì„ì ëª…ë¶€'</strong>ì— ì§ì ‘ ê¸°ì¬í•´ ì£¼ì„¸ìš”.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ëª¨ë°”ì¼ ë²„íŠ¼ë“¤ -->
    <div class="mobile-buttons" id="mobileButtons" style="display: none;">
        <button class="mobile-btn refresh" onclick="forceRefresh()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        <button class="mobile-btn diagnose" onclick="diagnoseAndFix()">ğŸ” ì§„ë‹¨ìˆ˜ì •</button>
    </div>

    <script>
        console.log('ğŸš€ ì‚¬ìš©ì í˜ì´ì§€ ì‹œì‘');
        
        // ì „ì—­ ì„¤ì •
        window.userPageConfig = {
            eventTitle: 'ğŸ“ ì„¸ë¯¸ë‚˜ì‹¤ ì¶œì„ ì²´í¬',
            eventDescription: 'í–‰ì‚¬ ì°¸ì„ í™•ì¸ì„ ìœ„í•´ ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”',
            manualInstruction: 'í–‰ì‚¬ì¥ ì•ìª½ì— ë¹„ì¹˜ëœ <strong>\'ì°¸ì„ì ëª…ë¶€\'</strong>ì— ì§ì ‘ ê¸°ì¬í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.',
            allowedLocations: [
                { name: "ë‹¨í˜¸í™€", lat: 37.228848, lng: 127.167855, radius: 30 },
                { name: "ë²½ì†Œí™€", lat: 37.228767, lng: 127.167449, radius: 30 },
                { name: "ëŒ€í•™êµ ë³¸ê´€", lat: 37.227239, lng: 127.166598, radius: 50 }
            ]
        };

        // ëª¨ë°”ì¼ ê°ì§€
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // ë””ë²„ê·¸ í† ê¸€ í•¨ìˆ˜
        function toggleDebug() {
            const debugPanel = document.getElementById('debugPanel');
            if (debugPanel.style.display === 'none') {
                debugPanel.style.display = 'block';
                updateDebugInfo();
            } else {
                debugPanel.style.display = 'none';
            }
        }

        // ë””ë²„ê·¸ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateDebugInfo() {
            const debugContent = document.getElementById('debugContent');
            
            let info = [];
            info.push(`ì‹œê°„: ${new Date().toLocaleTimeString()}`);
            info.push(`ëª¨ë°”ì¼: ${isMobile ? 'Yes' : 'No'}`);
            info.push('');
            
            // localStorage í‚¤ í™•ì¸
            const keys = ['attendanceConfig', 'eventConfig', 'checkConfig', 'eventTitle', 'eventDescription', 'manualInstruction'];
            info.push('ğŸ“¦ ì €ì¥ëœ ì„¤ì •:');
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                info.push(`${key}: ${value ? 'âœ… ìˆìŒ' : 'âŒ ì—†ìŒ'}`);
                if (value && key === 'attendanceConfig') {
                    try {
                        const config = JSON.parse(value);
                        info.push(`  ì œëª©: "${config.eventTitle || 'N/A'}"`);
                        info.push(`  ì„¤ëª…: "${config.eventDescription || 'N/A'}"`);
                    } catch (e) {
                        info.push(`  íŒŒì‹± ì˜¤ë¥˜: ${e.message}`);
                    }
                }
            });
            
            info.push('');
            info.push('ğŸ  í˜„ì¬ DOM:');
            info.push(`ì œëª©: "${document.getElementById('eventTitle').textContent}"`);
            info.push(`ì„¤ëª…: "${document.getElementById('eventDescription').textContent}"`);
            
            debugContent.innerHTML = info.join('<br>');
        }

        // ê°•ì œ ìƒˆë¡œê³ ì¹¨
        function forceRefresh() {
            console.log('ğŸ”„ ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰');
            
            // ìºì‹œ ë²„ìŠ¤í„°ì™€ í•¨ê»˜ ìƒˆë¡œê³ ì¹¨
            const url = new URL(window.location);
            url.searchParams.set('_refresh', Date.now());
            window.location.href = url.toString();
        }

        // ì§„ë‹¨ ë° ìˆ˜ì •
        function diagnoseAndFix() {
            console.log('ğŸ” ì§„ë‹¨ ë° ìˆ˜ì • ì‹œì‘');
            
            let fixes = [];
            let hasChanges = false;
            
            // 1. localStorageì—ì„œ ì„¤ì • ì°¾ê¸°
            const configKeys = ['attendanceConfig', 'eventConfig', 'checkConfig'];
            let foundConfig = null;
            let configSource = '';
            
            for (const key of configKeys) {
                const configData = localStorage.getItem(key);
                if (configData) {
                    try {
                        foundConfig = JSON.parse(configData);
                        configSource = key;
                        console.log(`âœ… ì„¤ì • ë°œê²¬: ${key}`, foundConfig);
                        break;
                    } catch (e) {
                        console.warn(`âš ï¸ ${key} íŒŒì‹± ì‹¤íŒ¨:`, e);
                    }
                }
            }
            
            // ê°œë³„ í‚¤ì—ì„œë„ í™•ì¸
            if (!foundConfig) {
                const title = localStorage.getItem('eventTitle');
                const desc = localStorage.getItem('eventDescription');
                const manual = localStorage.getItem('manualInstruction');
                
                if (title || desc) {
                    foundConfig = {
                        eventTitle: title,
                        eventDescription: desc,
                        manualInstruction: manual
                    };
                    configSource = 'individual_keys';
                    console.log('âœ… ê°œë³„ í‚¤ì—ì„œ ì„¤ì • êµ¬ì„±:', foundConfig);
                }
            }
            
            if (foundConfig) {
                // 2. DOMê³¼ ë¹„êµí•˜ì—¬ ì—…ë°ì´íŠ¸
                const titleEl = document.getElementById('eventTitle');
                const descEl = document.getElementById('eventDescription');
                const manualEl = document.getElementById('manualInstructionText');
                const blockedManualEl = document.getElementById('blockedManualInstructionText');
                
                if (foundConfig.eventTitle && titleEl.textContent !== foundConfig.eventTitle) {
                    console.log(`ğŸ”§ ì œëª© ìˆ˜ì •: "${titleEl.textContent}" â†’ "${foundConfig.eventTitle}"`);
                    titleEl.textContent = foundConfig.eventTitle;
                    document.title = foundConfig.eventTitle;
                    fixes.push(`ì œëª©: ${foundConfig.eventTitle}`);
                    hasChanges = true;
                    
                    // ì‹œê°ì  íš¨ê³¼
                    titleEl.style.backgroundColor = '#ffeb3b';
                    setTimeout(() => titleEl.style.backgroundColor = '', 1000);
                }
                
                if (foundConfig.eventDescription && descEl.textContent !== foundConfig.eventDescription) {
                    console.log(`ğŸ”§ ì„¤ëª… ìˆ˜ì •: "${descEl.textContent}" â†’ "${foundConfig.eventDescription}"`);
                    descEl.textContent = foundConfig.eventDescription;
                    fixes.push(`ì„¤ëª…: ${foundConfig.eventDescription}`);
                    hasChanges = true;
                    
                    // ì‹œê°ì  íš¨ê³¼
                    descEl.style.backgroundColor = '#ffeb3b';
                    setTimeout(() => descEl.style.backgroundColor = '', 1000);
                }
                
                if (foundConfig.manualInstruction) {
                    if (manualEl) {
                        manualEl.innerHTML = foundConfig.manualInstruction;
                        fixes.push('ìˆ˜ë™ ì•ˆë‚´ë¬¸êµ¬');
                    }
                    if (blockedManualEl) {
                        blockedManualEl.innerHTML = foundConfig.manualInstruction;
                    }
                }
                
                // í—ˆìš© ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                if (foundConfig.allowedLocations) {
                    window.userPageConfig.allowedLocations = foundConfig.allowedLocations;
                    fixes.push('í—ˆìš© ìœ„ì¹˜');
                }
                
                // ì „ì—­ ì„¤ì • ì—…ë°ì´íŠ¸
                window.userPageConfig = { ...window.userPageConfig, ...foundConfig };
                
            } else {
                console.error('âŒ ì„¤ì • ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
            
            // 3. ê²°ê³¼ ì•Œë¦¼
            if (hasChanges) {
                showAlert(`âœ… ${fixes.length}ê°œ í•­ëª©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!\n- ${fixes.join('\n- ')}`, 'success');
            } else if (foundConfig) {
                showAlert('â„¹ï¸ ëª¨ë“  ì„¤ì •ì´ ì´ë¯¸ ìµœì‹  ìƒíƒœì…ë‹ˆë‹¤', 'info');
            } else {
                showAlert('âš ï¸ ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì„¤ì •ì„ ì €ì¥í•´ì£¼ì„¸ìš”', 'warning');
            }
            
            // ë””ë²„ê·¸ ì •ë³´ ì—…ë°ì´íŠ¸
            if (document.getElementById('debugPanel').style.display !== 'none') {
                updateDebugInfo();
            }
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showAlert(message, type = 'info') {
            const colors = {
                success: '#28a745',
                warning: '#ffc107', 
                error: '#dc3545',
                info: '#007bff'
            };
            
            const alert = document.createElement('div');
            alert.textContent = message;
            alert.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: ${colors[type]};
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                z-index: 10000;
                font-weight: bold;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                font-size: 14px;
                text-align: center;
                max-width: 80%;
                white-space: pre-line;
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transition = 'opacity 0.3s ease';
                setTimeout(() => document.body.removeChild(alert), 300);
            }, 3000);
        }

        // ê´€ë¦¬ì ì„¤ì • ë¡œë“œ (í•µì‹¬ í•¨ìˆ˜)
        function loadAdminSettings() {
            console.log('ğŸ”„ ê´€ë¦¬ì ì„¤ì • ë¡œë“œ ì‹œì‘');
            
            try {
                const configKeys = ['attendanceConfig', 'eventConfig', 'checkConfig'];
                let loadedConfig = null;
                let usedKey = '';
                
                // í†µí•© ì„¤ì • ìš°ì„  í™•ì¸
                for (const key of configKeys) {
                    const configData = localStorage.getItem(key);
                    if (configData) {
                        try {
                            loadedConfig = JSON.parse(configData);
                            usedKey = key;
                            console.log(`âœ… ì„¤ì • ë¡œë“œ ì„±ê³µ: ${key}`, loadedConfig);
                            break;
                        } catch (e) {
                            console.warn(`âš ï¸ ${key} íŒŒì‹± ì˜¤ë¥˜:`, e);
                        }
                    }
                }
                
                // ê°œë³„ í‚¤ì—ì„œë„ í™•ì¸
                if (!loadedConfig) {
                    const title = localStorage.getItem('eventTitle');
                    const desc = localStorage.getItem('eventDescription');
                    const manual = localStorage.getItem('manualInstruction');
                    
                    if (title || desc) {
                        loadedConfig = {
                            eventTitle: title,
                            eventDescription: desc,
                            manualInstruction: manual
                        };
                        usedKey = 'individual_keys';
                        console.log('âœ… ê°œë³„ í‚¤ì—ì„œ ì„¤ì • êµ¬ì„±:', loadedConfig);
                    }
                }
                
                if (loadedConfig) {
                    applyConfig(loadedConfig);
                    console.log(`âœ… ì„¤ì • ì ìš© ì™„ë£Œ (ì¶œì²˜: ${usedKey})`);
                } else {
                    console.log('â„¹ï¸ ì €ì¥ëœ ê´€ë¦¬ì ì„¤ì • ì—†ìŒ, ê¸°ë³¸ê°’ ì‚¬ìš©');
                }
                
            } catch (e) {
                console.error('âŒ ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', e);
            }
        }

        // ì„¤ì • ì ìš©
        function applyConfig(config) {
            if (config.eventTitle) {
                document.getElementById('eventTitle').textContent = config.eventTitle;
                document.title = config.eventTitle;
                window.userPageConfig.eventTitle = config.eventTitle;
            }
            
            if (config.eventDescription) {
                document.getElementById('eventDescription').textContent = config.eventDescription;
                window.userPageConfig.eventDescription = config.eventDescription;
            }
            
            if (config.manualInstruction) {
                const manualEl = document.getElementById('manualInstructionText');
                const blockedManualEl = document.getElementById('blockedManualInstructionText');
                if (manualEl) manualEl.innerHTML = config.manualInstruction;
                if (blockedManualEl) blockedManualEl.innerHTML = config.manualInstruction;
                window.userPageConfig.manualInstruction = config.manualInstruction;
            }
            
            if (config.allowedLocations) {
                window.userPageConfig.allowedLocations = config.allowedLocations;
            }
        }

        // ì¶œì„ ì‹œìŠ¤í…œ ê¸°ë³¸ í•¨ìˆ˜ë“¤
        class AttendanceSystem {
            constructor() {
                this.deviceFingerprint = this.generateDeviceFingerprint();
                this.locationVerified = false;
                this.currentLocation = null;
                this.init();
            }

            generateDeviceFingerprint() {
                const fingerprint = {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    screen: `${screen.width}x${screen.height}`,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    platform: navigator.platform
                };
                return this.simpleHash(JSON.stringify(fingerprint));
            }

            simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(36);
            }

            init() {
                this.displayDeviceInfo();
                
                if (this.checkIfBlocked()) {
                    return;
                }
                
                this.setupEventListeners();
            }

            checkIfBlocked() {
                const sessionBlocked = sessionStorage.getItem('attendance_submitted');
                const deviceBlocked = localStorage.getItem(`attendance_${this.deviceFingerprint}`);
                
                if (sessionBlocked || deviceBlocked) {
                    this.showBlockedMessage();
                    return true;
                }
                return false;
            }

            showBlockedMessage() {
                document.getElementById('attendanceForm').style.display = 'none';
                document.getElementById('blockedMessage').style.display = 'block';
            }

            setupEventListeners() {
                document.getElementById('locationBtn').addEventListener('click', () => this.checkLocation());
                document.getElementById('checkInForm').addEventListener('submit', (e) => this.handleSubmit(e));
            }

            async checkLocation() {
                const locationBtn = document.getElementById('locationBtn');
                const locationInfo = document.getElementById('locationInfo');
                const locationResult = document.getElementById('locationResult');

                this.setLocationButtonState('checking');
                locationInfo.style.display = 'block';

                try {
                    const position = await this.getCurrentPosition();
                    const { latitude, longitude, accuracy } = position.coords;

                    const allowedLocation = this.isLocationAllowed(latitude, longitude);

                    if (allowedLocation) {
                        this.locationVerified = true;
                        this.currentLocation = {
                            lat: latitude,
                            lng: longitude,
                            name: allowedLocation.name,
                            distance: allowedLocation.distance,
                            accuracy: accuracy
                        };

                        this.setLocationButtonState('success');
                        
                        locationResult.innerHTML = `
                            <div class="location-success">
                                <strong>âœ… ìœ„ì¹˜ í™•ì¸ ì„±ê³µ!</strong><br>
                                í˜„ì¬ ìœ„ì¹˜: ${allowedLocation.name}<br>
                                ê±°ë¦¬: ì•½ ${Math.round(allowedLocation.distance)}m<br>
                                ì •í™•ë„: Â±${Math.round(accuracy)}m
                            </div>
                        `;

                        document.getElementById('location').value = allowedLocation.name;
                        document.getElementById('coordinates').value = `${latitude},${longitude}`;

                    } else {
                        throw new Error(`í—ˆìš©ëœ ìœ„ì¹˜ê°€ ì•„ë‹™ë‹ˆë‹¤. ì„¸ë¯¸ë‚˜ì‹¤ ë‚´ë¶€ì—ì„œ ì‹œë„í•´ ì£¼ì„¸ìš”.`);
                    }

                } catch (error) {
                    this.handleLocationError(error, locationResult);
                }
            }

            setLocationButtonState(state) {
                const locationBtn = document.getElementById('locationBtn');
                locationBtn.disabled = state === 'checking';
                
                switch(state) {
                    case 'checking':
                        locationBtn.className = 'location-btn checking';
                        locationBtn.innerHTML = 'ğŸ”„ ìœ„ì¹˜ í™•ì¸ ì¤‘...';
                        break;
                    case 'success':
                        locationBtn.className = 'location-btn success';
                        locationBtn.innerHTML = 'âœ… ìœ„ì¹˜ í™•ì¸ ì™„ë£Œ';
                        break;
                    case 'error':
                        locationBtn.className = 'location-btn error';
                        locationBtn.innerHTML = 'âŒ ìœ„ì¹˜ í™•ì¸ ì‹¤íŒ¨';
                        setTimeout(() => {
                            locationBtn.disabled = false;
                            locationBtn.className = 'location-btn';
                            locationBtn.innerHTML = 'ğŸ“ ìœ„ì¹˜ ë‹¤ì‹œ í™•ì¸';
                        }, 3000);
                        break;
                }
            }

            handleLocationError(error, locationResult) {
                this.setLocationButtonState('error');
                this.locationVerified = false;
                
                document.getElementById('location').value = '';
                document.getElementById('coordinates').value = '';

                locationResult.innerHTML = `
                    <div class="location-error">
                        <strong>âŒ ìœ„ì¹˜ í™•ì¸ ì‹¤íŒ¨</strong><br>
                        ${error.message}
                    </div>
                `;
            }

            getCurrentPosition() {
                return new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        resolve,
                        reject,
                        {
                            enableHighAccuracy: true,
                            timeout: 15000,
                            maximumAge: 300000
                        }
                    );
                });
            }

            isLocationAllowed(lat, lng) {
                for (const location of window.userPageConfig.allowedLocations) {
                    const distance = this.calculateDistance(lat, lng, location.lat, location.lng);
                    if (distance <= location.radius) {
                        return { name: location.name, distance: distance };
                    }
                }
                return null;
            }

            calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371e3;
                const Ï†1 = lat1 * Math.PI/180;
                const Ï†2 = lat2 * Math.PI/180;
                const Î”Ï† = (lat2-lat1) * Math.PI/180;
                const Î”Î» = (lng2-lng1) * Math.PI/180;

                const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                          Math.cos(Ï†1) * Math.cos(Ï†2) *
                          Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                return R * c;
            }

            async handleSubmit(e) {
                e.preventDefault();
                
                if (this.checkIfBlocked()) {
                    return;
                }

                const formData = new FormData(e.target);
                const submitBtn = document.getElementById('submitBtn');
                
                submitBtn.disabled = true;
                submitBtn.textContent = 'ì œì¶œ ì¤‘...';

                try {
                    if (!this.validateForm(formData)) {
                        return;
                    }

                    await this.submitData(formData);

                    this.markAsSubmitted();
                    showAlert('âœ… ì¶œì„ ì²´í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    
                    setTimeout(() => {
                        this.showBlockedMessage();
                    }, 2000);

                } catch (error) {
                    console.error('ì œì¶œ ì˜¤ë¥˜:', error);
                    showAlert('âŒ ì¶œì„ ì²´í¬ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ì¶œì„ ì²´í¬ ì™„ë£Œ';
                }
            }

            validateForm(formData) {
                const name = formData.get('name')?.trim();
                const affiliation = formData.get('affiliation')?.trim();
                const location = formData.get('location');

                if (!name || !affiliation) {
                    showAlert('ì´ë¦„ê³¼ ì†Œì†ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.', 'warning');
                    return false;
                }

                if (!this.locationVerified || !location) {
                    showAlert('GPS ìœ„ì¹˜ í™•ì¸ì„ ë¨¼ì € ì™„ë£Œí•´ ì£¼ì„¸ìš”.', 'warning');
                    return false;
                }

                return true;
            }

            async submitData(formData) {
                const submitData = {
                    name: formData.get('name')?.trim(),
                    affiliation: formData.get('affiliation')?.trim(),
                    email: formData.get('email')?.trim() || '',
                    phone: formData.get('phone')?.trim() || '',
                    location: formData.get('location'),
                    coordinates: formData.get('coordinates') || '',
                    timestamp: new Date().toISOString(),
                    deviceId: this.deviceFingerprint,
                    userAgent: navigator.userAgent
                };

                // localStorageì— ì¶œì„ ë°ì´í„° ì €ì¥
                try {
                    const existingData = JSON.parse(localStorage.getItem('attendanceData') || '[]');
                    existingData.push(submitData);
                    localStorage.setItem('attendanceData', JSON.stringify(existingData));
                    console.log('ì¶œì„ ë°ì´í„° ì €ì¥ ì™„ë£Œ');
                } catch (storageError) {
                    console.warn('localStorage ì €ì¥ ì‹¤íŒ¨:', storageError);
                }

                // ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œ ì„œë²„ ì—°ë™ ì‹œ ì—¬ê¸°ì— fetch ì¶”ê°€)
                await new Promise(resolve => setTimeout(resolve, 1000));
                return { success: true };
            }

            markAsSubmitted() {
                const timestamp = Date.now().toString();
                
                try {
                    sessionStorage.setItem('attendance_submitted', 'true');
                    sessionStorage.setItem('attendance_timestamp', timestamp);
                } catch (e) {
                    console.warn('SessionStorage ì €ì¥ ì‹¤íŒ¨:', e);
                }

                try {
                    localStorage.setItem(`attendance_${this.deviceFingerprint}`, timestamp);
                } catch (e) {
                    console.warn('LocalStorage ì €ì¥ ì‹¤íŒ¨:', e);
                }
            }

            displayDeviceInfo() {
                try {
                    const deviceInfo = document.getElementById('deviceInfo');
                    const browserName = this.getBrowserName();
                    const osName = this.getOSName();
                    
                    deviceInfo.innerHTML = `
                        <strong>ê¸°ê¸° ì •ë³´:</strong><br>
                        ë¸Œë¼ìš°ì €: ${browserName}<br>
                        ìš´ì˜ì²´ì œ: ${osName}<br>
                        í™”ë©´: ${screen.width}Ã—${screen.height}<br>
                        ì–¸ì–´: ${navigator.language}<br>
                        ê¸°ê¸° ID: ${this.deviceFingerprint.substring(0, 8)}...
                    `;
                } catch (error) {
                    console.warn('ê¸°ê¸° ì •ë³´ í‘œì‹œ ì˜¤ë¥˜:', error);
                }
            }

            getBrowserName() {
                const ua = navigator.userAgent;
                if (ua.includes('Chrome')) return 'Chrome';
                if (ua.includes('Firefox')) return 'Firefox';
                if (ua.includes('Safari')) return 'Safari';
                if (ua.includes('Edge')) return 'Edge';
                return 'Unknown';
            }

            getOSName() {
                const ua = navigator.userAgent;
                if (ua.includes('Windows')) return 'Windows';
                if (ua.includes('Mac')) return 'macOS';
                if (ua.includes('Linux')) return 'Linux';
                if (ua.includes('Android')) return 'Android';
                if (ua.includes('iPhone') || ua.includes('iPad')) return 'iOS';
                return navigator.platform || 'Unknown';
            }
        }

        // Storage ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ë‹¤ë¥¸ íƒ­ì—ì„œ ì„¤ì • ë³€ê²½ ê°ì§€)
        window.addEventListener('storage', function(e) {
            if (e.key === 'attendanceConfig' || e.key === 'eventTitle' || e.key === 'eventDescription') {
                console.log('ğŸ“¡ ì„¤ì • ë³€ê²½ ê°ì§€, ì¦‰ì‹œ ì¬ë¡œë“œ');
                setTimeout(() => {
                    loadAdminSettings();
                    if (document.getElementById('debugPanel').style.display !== 'none') {
                        updateDebugInfo();
                    }
                }, 100);
            }
        });

        // í˜ì´ì§€ visibility ë³€ê²½ ê°ì§€ (ëª¨ë°”ì¼ ì•± ì „í™˜ ëŒ€ì‘)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && isMobile) {
                console.log('ğŸ“± í˜ì´ì§€ ì¬í™œì„±í™”: ì„¤ì • ì¬í™•ì¸');
                setTimeout(() => {
                    loadAdminSettings();
                    if (document.getElementById('debugPanel').style.display !== 'none') {
                        updateDebugInfo();
                    }
                }, 100);
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ DOM ë¡œë“œ ì™„ë£Œ');
            
            try {
                // 1. ëª¨ë°”ì¼ ë²„íŠ¼ í‘œì‹œ
                if (isMobile) {
                    document.getElementById('mobileButtons').style.display = 'flex';
                    document.getElementById('debugPanel').style.display = 'block';
                    updateDebugInfo();
                }
                
                // 2. ê´€ë¦¬ì ì„¤ì • ë¡œë“œ
                loadAdminSettings();
                
                // 3. ì¶œì„ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
                setTimeout(() => {
                    new AttendanceSystem();
                    console.log('âœ… ì¶œì„ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
                }, 100);
                
                // 4. ëª¨ë°”ì¼ì—ì„œ ì¶”ê°€ ì¬í™•ì¸
                if (isMobile) {
                    [500, 1000, 2000].forEach(delay => {
                        setTimeout(() => {
                            console.log(`ğŸ“± ${delay}ms í›„ ì¬í™•ì¸`);
                            loadAdminSettings();
                        }, delay);
                    });
                }
                
                console.log('âœ… í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showAlert('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        });

        // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬
        window.addEventListener('error', (event) => {
            console.error('ì „ì—­ ì˜¤ë¥˜:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€:', event.reason);
        });

        console.log('âœ… ì‚¬ìš©ì í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
    </script>
</body>
</html>
