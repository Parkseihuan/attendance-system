<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„¸ë¯¸ë‚˜ì‹¤ ì¶œì„ ì²´í¬</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 500px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #f9ca24);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .autocomplete-detected {
            background-color: #d4edda !important;
            border-color: #28a745 !important;
        }

        .warning-message, .error-message, .success-message {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            display: none;
        }

        .warning-message {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .error-message {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .success-message {
            background-color: #d1edff;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .submit-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .device-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 12px;
            color: #6c757d;
        }

        .timestamp {
            text-align: center;
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 20px;
        }

        .blocked-message {
            text-align: center;
            color: #e74c3c;
            font-size: 18px;
            font-weight: 600;
        }

        .manual-instruction {
            background: #e8f4f8;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .manual-instruction h3 {
            color: #17a2b8;
            margin-bottom: 10px;
        }

        .fingerprint-info {
            font-size: 10px;
            color: #adb5bd;
            margin-top: 10px;
            text-align: center;
        }

        .location-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .location-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(40, 167, 69, 0.3);
        }

        .location-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .location-btn.checking {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }

        .location-btn.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .location-btn.error {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .location-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .location-result {
            font-size: 14px;
            line-height: 1.5;
        }

        .location-success {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .location-error {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .coordinates-info {
            font-size: 12px;
            color: #6c757d;
            margin-top: 8px;
            font-family: monospace;
            background: #f1f3f4;
            padding: 8px;
            border-radius: 4px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .modal-message {
            font-size: 16px;
            color: #555;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .modal-close-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .modal-icon.success { color: #28a745; }
        .modal-icon.error { color: #dc3545; }
        .modal-icon.warning { color: #ffc107; }

        @media (max-width: 600px) {
            .container {
                padding: 30px 20px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container rounded-xl">
        <div class="header">
            <h1>ğŸ“ ì„¸ë¯¸ë‚˜ì‹¤ ì¶œì„ ì²´í¬</h1>
            <p>í–‰ì‚¬ ì°¸ì„ í™•ì¸ì„ ìœ„í•´ ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”</p>
        </div>

        <div id="attendanceForm">
            <form id="checkInForm">
                <div class="form-group">
                    <label for="name">ì´ë¦„ *</label>
                    <input type="text" id="name" name="name" required autocomplete="name" class="rounded-lg">
                </div>

                <div class="form-group">
                    <label for="affiliation">ì†Œì† *</label>
                    <input type="text" id="affiliation" name="affiliation" required autocomplete="organization" class="rounded-lg">
                </div>

                <div class="form-group">
                    <label for="email">ì´ë©”ì¼</label>
                    <input type="email" id="email" name="email" autocomplete="email" class="rounded-lg">
                </div>

                <div class="form-group">
                    <label for="phone">ì—°ë½ì²˜</label>
                    <input type="tel" id="phone" name="phone" autocomplete="tel" class="rounded-lg">
                </div>

                <div class="form-group">
                    <label for="location">ìœ„ì¹˜ í™•ì¸ *</label>
                    <div class="location-status" id="locationStatus">
                        <button type="button" class="location-btn rounded-lg" id="locationBtn">
                            ğŸ“ í˜„ì¬ ìœ„ì¹˜ í™•ì¸
                        </button>
                        <div class="location-info rounded-lg" id="locationInfo" style="display: none;">
                            <div class="location-result" id="locationResult"></div>
                        </div>
                    </div>
                    <input type="hidden" id="location" name="location" required>
                    <input type="hidden" id="coordinates" name="coordinates">
                </div>

                <div class="warning-message rounded-lg" id="warningMessage">
                    âš ï¸ ì…ë ¥í•˜ì‹  ì •ë³´ì™€ ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ì •ë³´ê°€ ë‹¤ë¦…ë‹ˆë‹¤. ì •í™•í•œ ì •ë³´ì¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.
                </div>

                <button type="submit" class="submit-btn rounded-lg" id="submitBtn">ì¶œì„ ì²´í¬ ì™„ë£Œ</button>
            </form>

            <div class="manual-instruction rounded-r-lg">
                <h3>ğŸ“± íœ´ëŒ€í° ì‚¬ìš©ì´ ì–´ë ¤ìš°ì‹  ê²½ìš°</h3>
                <p>í–‰ì‚¬ì¥ ì•ìª½ì— ë¹„ì¹˜ëœ <strong>'ì°¸ì„ì ëª…ë¶€'</strong>ì— ì§ì ‘ ê¸°ì¬í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
            </div>

            <div class="device-info rounded-lg" id="deviceInfo"></div>
            <div class="fingerprint-info">
                ë³´ì•ˆì„ ìœ„í•´ ê¸°ê¸° ì •ë³´ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤ (ì¤‘ë³µ ì²´í¬ ë°©ì§€ìš©)
            </div>
        </div>

        <div id="blockedMessage" style="display: none;">
            <div class="blocked-message">
                <h2>ğŸš« ì´ë¯¸ ì¶œì„ ì²´í¬ ì™„ë£Œ</h2>
                <p>ì´ ê¸°ê¸°ì—ì„œëŠ” ì´ë¯¸ ì¶œì„ ì²´í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                <div class="manual-instruction rounded-r-lg">
                    <h3>ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ì¶œì„ ì²´í¬</h3>
                    <p>í–‰ì‚¬ì¥ ì•ìª½ì— ë¹„ì¹˜ëœ <strong>'ì°¸ì„ì ëª…ë¶€'</strong>ì— ì§ì ‘ ê¸°ì¬í•´ ì£¼ì„¸ìš”.</p>
                </div>
            </div>
        </div>

        <div class="timestamp" id="timestamp"></div>
    </div>

    <!-- Custom Modal for Alerts -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-content rounded-xl">
            <div id="modalIcon" class="modal-icon"></div>
            <h3 id="modalTitle" class="modal-title"></h3>
            <p id="modalMessage" class="modal-message"></p>
            <button id="modalCloseBtn" class="modal-close-btn rounded-lg">í™•ì¸</button>
        </div>
    </div>

    <script>
        // êµ¬ì„± ì„¤ì •
        const CONFIG = {
            // Google Apps Script URL (ì‹¤ì œ ë°°í¬ëœ URLë¡œ ë³€ê²½ í•„ìš”)
            GOOGLE_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycby2Ud9x9UUL8-3H6TE2tZfmLr-Cfd1zTFcI9qD_r2v8WSsoxywM6o_ApHmgbbQQ1jse/exec',
            // ì¬ì‹œë„ ì„¤ì •
            MAX_RETRIES: 3,
            RETRY_DELAY: 1000, // 1ì´ˆ
            
            // ìœ„ì¹˜ ì„¤ì •
            GPS_TIMEOUT: 15000, // 15ì´ˆ
            GPS_MAX_AGE: 300000, // 5ë¶„
            
            // í—ˆìš©ëœ ìœ„ì¹˜ (ì‹¤ì œ ì¢Œí‘œë¡œ ë³€ê²½ í•„ìš”)
            ALLOWED_LOCATIONS: [
                {
                    name: "ë‹¨í˜¸í™€",
                    lat: 37.228848,
                    lng: 127.167855,
                    radius: 30
                },
                {
                    name: "ë²½ì†Œí™€", 
                    lat: 37.228767,
                    lng: 127.167449,
                    radius: 30
                },
                {
                    name: "ëŒ€í•™êµ ë³¸ê´€",
                    lat: 37.227239,
                    lng: 127.166598,
                    radius: 50
                }
            ]
        };

        class AttendanceSystem {
            constructor() {
                this.deviceFingerprint = this.generateDeviceFingerprint();
                this.autocompleteData = {};
                this.currentLocation = null;
                this.locationVerified = false;
                this.submissionAttempts = 0;
                this.init();
            }

            generateDeviceFingerprint() {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    ctx.textBaseline = 'top';
                    ctx.font = '14px Arial';
                    ctx.fillText('Device fingerprint test', 2, 2);
                    
                    const fingerprint = {
                        userAgent: navigator.userAgent,
                        language: navigator.language,
                        languages: navigator.languages?.join(',') || '',
                        platform: navigator.platform,
                        screen: `${screen.width}x${screen.height}x${screen.colorDepth}`,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                        canvas: canvas.toDataURL(),
                        cookieEnabled: navigator.cookieEnabled,
                        doNotTrack: navigator.doNotTrack || 'unspecified',
                        hardwareConcurrency: navigator.hardwareConcurrency || 0,
                        touchSupport: 'ontouchstart' in window,
                        webglRenderer: this.getWebGLRenderer()
                    };

                    return this.simpleHash(JSON.stringify(fingerprint));
                } catch (error) {
                    console.warn('Fingerprint generation error:', error);
                    return this.simpleHash(navigator.userAgent + Date.now());
                }
            }

            getWebGLRenderer() {
                try {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    if (gl) {
                        const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                        return debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : 'unknown';
                    }
                    return 'not_supported';
                } catch (error) {
                    return 'error';
                }
            }

            simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(36);
            }

            init() {
                this.updateTimestamp();
                this.displayDeviceInfo();
                
                if (this.checkIfBlocked()) {
                    return;
                }
                
                this.setupEventListeners();
                this.detectAutocomplete();
                
                setInterval(() => this.updateTimestamp(), 1000);
            }

            checkIfBlocked() {
                const sessionBlocked = sessionStorage.getItem('attendance_submitted');
                const deviceBlocked = localStorage.getItem(`attendance_${this.deviceFingerprint}`);
                
                const cookies = document.cookie.split(';').map(c => c.trim());
                const cookieBlocked = cookies.some(cookie => 
                    cookie.startsWith(`attendance_${this.deviceFingerprint}=`)
                );

                if (sessionBlocked || deviceBlocked || cookieBlocked) {
                    this.showBlockedMessage();
                    return true;
                }
                return false;
            }

            showBlockedMessage() {
                document.getElementById('attendanceForm').style.display = 'none';
                document.getElementById('blockedMessage').style.display = 'block';
            }

            setupEventListeners() {
                const form = document.getElementById('checkInForm');
                const inputs = form.querySelectorAll('input[autocomplete]');

                inputs.forEach(input => {
                    input.addEventListener('input', () => this.checkAutocompleteMatch(input));
                    input.addEventListener('change', () => this.checkAutocompleteMatch(input));
                });

                document.getElementById('locationBtn').addEventListener('click', () => this.checkLocation());
                document.getElementById('modalCloseBtn').addEventListener('click', () => this.hideModal());
                
                form.addEventListener('submit', (e) => this.handleSubmit(e));

                // í˜ì´ì§€ ìˆ¨ê¹€/í‘œì‹œ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ëŒ€ì‘)
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        this.updateTimestamp();
                    }
                });
            }

            detectAutocomplete() {
                setTimeout(() => {
                    const inputs = document.querySelectorAll('input[autocomplete]');
                    inputs.forEach(input => {
                        if (input.value && input.value.trim() !== '') {
                            this.autocompleteData[input.name] = input.value.trim();
                            input.classList.add('autocomplete-detected');
                        }
                    });
                }, 500);
            }

            checkAutocompleteMatch(input) {
                const fieldName = input.name;
                const currentValue = input.value.trim();
                const autocompleteValue = this.autocompleteData[fieldName];

                if (autocompleteValue && currentValue && 
                    currentValue.toLowerCase() !== autocompleteValue.toLowerCase()) {
                    this.showWarning('âš ï¸ ì…ë ¥í•˜ì‹  ì •ë³´ì™€ ë¸Œë¼ìš°ì € ìë™ì™„ì„± ì •ë³´ê°€ ë‹¤ë¦…ë‹ˆë‹¤.');
                } else {
                    this.hideWarning();
                }
            }

            showWarning(message) {
                const warningDiv = document.getElementById('warningMessage');
                warningDiv.textContent = message;
                warningDiv.style.display = 'block';
            }

            hideWarning() {
                document.getElementById('warningMessage').style.display = 'none';
            }

            showModal(type, title, message) {
                const modalOverlay = document.getElementById('customModal');
                const modalIcon = document.getElementById('modalIcon');
                const modalTitle = document.getElementById('modalTitle');
                const modalMessage = document.getElementById('modalMessage');

                modalIcon.className = `modal-icon ${type}`;
                switch(type) {
                    case 'success': modalIcon.textContent = 'âœ…'; break;
                    case 'error': modalIcon.textContent = 'âŒ'; break;
                    case 'warning': modalIcon.textContent = 'âš ï¸'; break;
                    default: modalIcon.textContent = 'â„¹ï¸';
                }

                modalTitle.textContent = title;
                modalMessage.innerHTML = message;
                
                modalOverlay.classList.add('active');
            }

            hideModal() {
                document.getElementById('customModal').classList.remove('active');
            }

            async checkLocation() {
                const locationBtn = document.getElementById('locationBtn');
                const locationInfo = document.getElementById('locationInfo');
                const locationResult = document.getElementById('locationResult');

                this.setLocationButtonState('checking');
                locationInfo.style.display = 'block';

                try {
                    if (!navigator.geolocation) {
                        throw new Error('ì´ ë¸Œë¼ìš°ì €ëŠ” GPS ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    }

                    const position = await this.getCurrentPosition();
                    const { latitude, longitude, accuracy } = position.coords;

                    console.log(`GPS ì •í™•ë„: ${accuracy}m`);

                    const allowedLocation = this.isLocationAllowed(latitude, longitude);

                    if (allowedLocation) {
                        this.locationVerified = true;
                        this.currentLocation = {
                            lat: latitude,
                            lng: longitude,
                            name: allowedLocation.name,
                            distance: allowedLocation.distance,
                            accuracy: accuracy
                        };

                        this.setLocationButtonState('success');
                        
                        locationResult.innerHTML = `
                            <div class="location-success">
                                <strong>âœ… ìœ„ì¹˜ í™•ì¸ ì„±ê³µ!</strong><br>
                                í˜„ì¬ ìœ„ì¹˜: ${allowedLocation.name}<br>
                                ê±°ë¦¬: ì•½ ${Math.round(allowedLocation.distance)}m<br>
                                ì •í™•ë„: Â±${Math.round(accuracy)}m
                            </div>
                            <div class="coordinates-info">
                                ì¢Œí‘œ: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}
                            </div>
                        `;

                        document.getElementById('location').value = allowedLocation.name;
                        document.getElementById('coordinates').value = `${latitude},${longitude}`;

                    } else {
                        throw new Error(`í—ˆìš©ëœ ìœ„ì¹˜ê°€ ì•„ë‹™ë‹ˆë‹¤. ì„¸ë¯¸ë‚˜ì‹¤ ë‚´ë¶€ì—ì„œ ì‹œë„í•´ ì£¼ì„¸ìš”. (ì •í™•ë„: Â±${Math.round(accuracy)}m)`);
                    }

                } catch (error) {
                    console.error('ìœ„ì¹˜ í™•ì¸ ì˜¤ë¥˜:', error);
                    this.handleLocationError(error, locationResult);
                }
            }

            setLocationButtonState(state) {
                const locationBtn = document.getElementById('locationBtn');
                locationBtn.disabled = state === 'checking';
                
                switch(state) {
                    case 'checking':
                        locationBtn.className = 'location-btn checking';
                        locationBtn.innerHTML = 'ğŸ”„ ìœ„ì¹˜ í™•ì¸ ì¤‘...';
                        break;
                    case 'success':
                        locationBtn.className = 'location-btn success';
                        locationBtn.innerHTML = 'âœ… ìœ„ì¹˜ í™•ì¸ ì™„ë£Œ';
                        break;
                    case 'error':
                        locationBtn.className = 'location-btn error';
                        locationBtn.innerHTML = 'âŒ ìœ„ì¹˜ í™•ì¸ ì‹¤íŒ¨';
                        setTimeout(() => {
                            locationBtn.disabled = false;
                            locationBtn.className = 'location-btn';
                            locationBtn.innerHTML = 'ğŸ“ ìœ„ì¹˜ ë‹¤ì‹œ í™•ì¸';
                        }, 3000);
                        break;
                }
            }

            handleLocationError(error, locationResult) {
                this.setLocationButtonState('error');
                this.locationVerified = false;
                
                document.getElementById('location').value = '';
                document.getElementById('coordinates').value = '';

                let errorMessage = error.message;
                let helpText = '';

                if (error.code) {
                    switch (error.code) {
                        case 1: // PERMISSION_DENIED
                            helpText = 'â€¢ ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ì˜ ìœ„ì¹˜ ì•„ì´ì½˜ì„ í´ë¦­í•˜ì—¬ í—ˆìš©í•´ì£¼ì„¸ìš”<br>â€¢ ì„¤ì • > ê°œì¸ì •ë³´ ë³´í˜¸ > ìœ„ì¹˜ ì„œë¹„ìŠ¤ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”';
                            break;
                        case 2: // POSITION_UNAVAILABLE
                            helpText = 'â€¢ WiFië¥¼ ì¼œì£¼ì„¸ìš”<br>â€¢ ê±´ë¬¼ ë°–ì—ì„œ í•œ ë²ˆ ì‹œë„í•´ë³´ì„¸ìš”<br>â€¢ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”';
                            break;
                        case 3: // TIMEOUT
                            helpText = 'â€¢ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”<br>â€¢ WiFi ì‹ í˜¸ê°€ ê°•í•œ ê³³ì—ì„œ ì‹œë„í•´ì£¼ì„¸ìš”';
                            break;
                    }
                }

                locationResult.innerHTML = `
                    <div class="location-error">
                        <strong>âŒ ìœ„ì¹˜ í™•ì¸ ì‹¤íŒ¨</strong><br>
                        ${errorMessage}<br><br>
                        <small style="font-size: 12px; line-height: 1.4;">
                            ${helpText || 'â€¢ GPS ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”<br>â€¢ ì„¸ë¯¸ë‚˜ì‹¤ ë‚´ë¶€ì—ì„œ ì‹œë„í•´ ì£¼ì„¸ìš”<br>â€¢ WiFiì™€ ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì¼œì£¼ì„¸ìš”'}
                        </small>
                    </div>
                `;

                this.showModal('error', 'ìœ„ì¹˜ í™•ì¸ ì‹¤íŒ¨', errorMessage);
            }

            getCurrentPosition() {
                return new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        resolve,
                        reject,
                        {
                            enableHighAccuracy: true,
                            timeout: CONFIG.GPS_TIMEOUT,
                            maximumAge: CONFIG.GPS_MAX_AGE
                        }
                    );
                });
            }

            isLocationAllowed(lat, lng) {
                for (const location of CONFIG.ALLOWED_LOCATIONS) {
                    const distance = this.calculateDistance(lat, lng, location.lat, location.lng);
                    if (distance <= location.radius) {
                        return { name: location.name, distance: distance };
                    }
                }
                return null;
            }

            calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371e3;
                const Ï†1 = lat1 * Math.PI/180;
                const Ï†2 = lat2 * Math.PI/180;
                const Î”Ï† = (lat2-lat1) * Math.PI/180;
                const Î”Î» = (lng2-lng1) * Math.PI/180;

                const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                          Math.cos(Ï†1) * Math.cos(Ï†2) *
                          Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                return R * c;
            }

            async handleSubmit(e) {
                e.preventDefault();
                
                if (this.checkIfBlocked()) {
                    return;
                }

                const formData = new FormData(e.target);
                const submitBtn = document.getElementById('submitBtn');
                
                submitBtn.disabled = true;
                submitBtn.textContent = 'ì œì¶œ ì¤‘...';

                try {
                    if (!this.validateForm(formData)) {
                        return;
                    }

                    await this.submitDataWithRetry(formData);

                    this.markAsSubmitted();
                    this.showModal('success', 'ì¶œì„ ì²´í¬ ì™„ë£Œ!', 'âœ… ì¶œì„ ì²´í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    setTimeout(() => {
                        this.showBlockedMessage();
                    }, 2000);

                } catch (error) {
                    console.error('ì œì¶œ ì˜¤ë¥˜:', error);
                    this.showModal('error', 'ì œì¶œ ì‹¤íŒ¨', 
                        `âŒ ì¶œì„ ì²´í¬ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br><small>${error.message}</small>`);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ì¶œì„ ì²´í¬ ì™„ë£Œ';
                }
            }

            validateForm(formData) {
                const name = formData.get('name')?.trim();
                const affiliation = formData.get('affiliation')?.trim();
                const location = formData.get('location');

                if (!name || !affiliation) {
                    this.showModal('warning', 'í•„ìˆ˜ í•­ëª© ëˆ„ë½', 
                        'ì´ë¦„ê³¼ ì†Œì†ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
                    return false;
                }

                if (name.length < 2 || name.length > 50) {
                    this.showModal('warning', 'ì´ë¦„ ì˜¤ë¥˜', 
                        'ì´ë¦„ì€ 2ì ì´ìƒ 50ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return false;
                }

                if (affiliation.length < 2 || affiliation.length > 100) {
                    this.showModal('warning', 'ì†Œì† ì˜¤ë¥˜', 
                        'ì†Œì†ì€ 2ì ì´ìƒ 100ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return false;
                }

                if (!this.locationVerified || !location) {
                    this.showModal('warning', 'ìœ„ì¹˜ ë¯¸í™•ì¸', 
                        'GPS ìœ„ì¹˜ í™•ì¸ì„ ë¨¼ì € ì™„ë£Œí•´ ì£¼ì„¸ìš”.');
                    return false;
                }

                return true;
            }

            async submitDataWithRetry(formData) {
                this.submissionAttempts = 0;
                
                while (this.submissionAttempts < CONFIG.MAX_RETRIES) {
                    try {
                        this.submissionAttempts++;
                        return await this.submitData(formData);
                    } catch (error) {
                        console.warn(`ì œì¶œ ì‹œë„ ${this.submissionAttempts}/${CONFIG.MAX_RETRIES} ì‹¤íŒ¨:`, error);
                        
                        if (this.submissionAttempts >= CONFIG.MAX_RETRIES) {
                            throw new Error(`${CONFIG.MAX_RETRIES}ë²ˆ ì‹œë„ í›„ ì‹¤íŒ¨: ${error.message}`);
                        }
                        
                        // ì¬ì‹œë„ ì „ ëŒ€ê¸°
                        await new Promise(resolve => 
                            setTimeout(resolve, CONFIG.RETRY_DELAY * this.submissionAttempts)
                        );
                    }
                }
            }

            async submitData(formData) {
                const submitData = {
                    name: formData.get('name')?.trim(),
                    affiliation: formData.get('affiliation')?.trim(),
                    email: formData.get('email')?.trim() || '',
                    phone: formData.get('phone')?.trim() || '',
                    location: formData.get('location'),
                    coordinates: formData.get('coordinates') || '',
                    timestamp: new Date().toISOString(),
                    timestampKor: new Date().toLocaleString('ko-KR'),
                    deviceId: this.deviceFingerprint,
                    userAgent: navigator.userAgent,
                    submissionAttempt: this.submissionAttempts
                };

                if (CONFIG.GOOGLE_SCRIPT_URL && !CONFIG.GOOGLE_SCRIPT_URL.includes('YOUR_SCRIPT_ID')) {
                    console.log('Google Apps Scriptë¡œ ë°ì´í„° ì „ì†¡ ì‹œë„ ì¤‘...');
                    return await this.submitToAppsScript(submitData);
                }
                
                console.warn('Google Apps Script URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                console.log('ì œì¶œ ë°ì´í„° (ì‹œë®¬ë ˆì´ì…˜):', submitData);
                
                // ê°œë°œ/í…ŒìŠ¤íŠ¸ ëª¨ë“œ ì‹œë®¬ë ˆì´ì…˜
                await new Promise(resolve => setTimeout(resolve, 1000));
                return { success: true, message: 'URL ë¯¸ì„¤ì •ìœ¼ë¡œ ì‹œë®¬ë ˆì´ì…˜ë¨' };
            }

            async submitToAppsScript(data) {
                // ë°©ë²• 1: no-cors ëª¨ë“œë¡œ ì‹œë„ (ì‘ë‹µ í™•ì¸ ë¶ˆê°€í•˜ì§€ë§Œ ì „ì†¡ë¨)
                try {
                    console.log('Apps Script URL:', CONFIG.GOOGLE_SCRIPT_URL);
                    console.log('ì œì¶œ ë°ì´í„°:', data);

                    const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', // CORS ìš°íšŒ
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    // no-cors ëª¨ë“œì—ì„œëŠ” ì‘ë‹µ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ì—†ìŒ
                    // í•˜ì§€ë§Œ ìš”ì²­ì€ ì„œë²„ì— ì „ë‹¬ë¨
                    console.log('no-cors ëª¨ë“œë¡œ ì „ì†¡ ì™„ë£Œ (ì‘ë‹µ í™•ì¸ ë¶ˆê°€)');
                    return { success: true, message: 'no-cors ëª¨ë“œë¡œ ì „ì†¡ë¨', mode: 'no-cors' };

                } catch (noCorsError) {
                    console.warn('no-cors ëª¨ë“œ ì‹¤íŒ¨, JSONP ë°©ì‹ìœ¼ë¡œ ì¬ì‹œë„:', noCorsError);
                    
                    // ë°©ë²• 2: JSONP ë°©ì‹ìœ¼ë¡œ ì¬ì‹œë„
                    return await this.submitViaJSONP(data);
                }
            }

            async submitViaJSONP(data) {
                return new Promise((resolve, reject) => {
                    const callbackName = 'jsonpCallback' + Date.now() + Math.floor(Math.random() * 1000);
                    
                    console.log('JSONP ìš”ì²­ ì‹œì‘:', callbackName);
                    
                    // ì „ì—­ ì½œë°± í•¨ìˆ˜ ë“±ë¡
                    window[callbackName] = function(response) {
                        console.log('JSONP ì½œë°± ì‹¤í–‰ë¨:', response);
                        cleanup();
                        resolve(response);
                    };

                    // ì—ëŸ¬ ì²˜ë¦¬ë¥¼ ìœ„í•œ íƒ€ì„ì•„ì›ƒ
                    const timeoutId = setTimeout(() => {
                        console.warn('JSONP íƒ€ì„ì•„ì›ƒ ë°œìƒ');
                        cleanup();
                        reject(new Error('JSONP ìš”ì²­ íƒ€ì„ì•„ì›ƒ (15ì´ˆ)'));
                    }, 15000);

                    const cleanup = () => {
                        if (window[callbackName]) {
                            delete window[callbackName];
                        }
                        if (script && script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        if (timeoutId) {
                            clearTimeout(timeoutId);
                        }
                    };

                    // URL íŒŒë¼ë¯¸í„° ìƒì„±
                    const params = new URLSearchParams();
                    params.append('callback', callbackName);
                    params.append('data', JSON.stringify(data));
                    
                    const fullUrl = `${CONFIG.GOOGLE_SCRIPT_URL}?${params.toString()}`;
                    console.log('JSONP ìš”ì²­ URL:', fullUrl);

                    // ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ìƒì„±
                    const script = document.createElement('script');
                    script.src = fullUrl;
                    script.onload = function() {
                        console.log('JSONP ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì„±ê³µ');
                    };
                    script.onerror = function(event) {
                        console.error('JSONP ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', event);
                        cleanup();
                        reject(new Error('JSONP ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨'));
                    };

                    // DOMì— ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
                    console.log('JSONP ìŠ¤í¬ë¦½íŠ¸ DOMì— ì¶”ê°€');
                    document.head.appendChild(script);
                });
            }

            markAsSubmitted() {
                const timestamp = Date.now().toString();
                
                try {
                    sessionStorage.setItem('attendance_submitted', 'true');
                    sessionStorage.setItem('attendance_timestamp', timestamp);
                } catch (e) {
                    console.warn('SessionStorage ì €ì¥ ì‹¤íŒ¨:', e);
                }

                try {
                    localStorage.setItem(`attendance_${this.deviceFingerprint}`, timestamp);
                } catch (e) {
                    console.warn('LocalStorage ì €ì¥ ì‹¤íŒ¨:', e);
                }
                
                try {
                    document.cookie = `attendance_${this.deviceFingerprint}=submitted; max-age=${30*24*60*60}; path=/; SameSite=Lax; Secure`;
                } catch (e) {
                    console.warn('Cookie ì €ì¥ ì‹¤íŒ¨:', e);
                }
            }

            updateTimestamp() {
                try {
                    const now = new Date();
                    const timeString = now.toLocaleString('ko-KR', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        weekday: 'short'
                    });
                    document.getElementById('timestamp').textContent = `í˜„ì¬ ì‹œê°„: ${timeString}`;
                } catch (error) {
                    console.warn('íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                }
            }

            displayDeviceInfo() {
                try {
                    const deviceInfo = document.getElementById('deviceInfo');
                    const browserName = this.getBrowserName();
                    const osName = this.getOSName();
                    
                    deviceInfo.innerHTML = `
                        <strong>ê¸°ê¸° ì •ë³´:</strong><br>
                        ë¸Œë¼ìš°ì €: ${browserName}<br>
                        ìš´ì˜ì²´ì œ: ${osName}<br>
                        í™”ë©´: ${screen.width}Ã—${screen.height} (${screen.colorDepth}bit)<br>
                        ì–¸ì–´: ${navigator.language}<br>
                        í„°ì¹˜: ${('ontouchstart' in window) ? 'ì§€ì›' : 'ë¯¸ì§€ì›'}<br>
                        ê¸°ê¸° ID: ${this.deviceFingerprint.substring(0, 8)}...
                    `;
                } catch (error) {
                    console.warn('ê¸°ê¸° ì •ë³´ í‘œì‹œ ì˜¤ë¥˜:', error);
                }
            }

            getBrowserName() {
                const ua = navigator.userAgent;
                if (ua.includes('Chrome')) return 'Chrome';
                if (ua.includes('Firefox')) return 'Firefox';
                if (ua.includes('Safari')) return 'Safari';
                if (ua.includes('Edge')) return 'Edge';
                return 'Unknown';
            }

            getOSName() {
                const ua = navigator.userAgent;
                if (ua.includes('Windows')) return 'Windows';
                if (ua.includes('Mac')) return 'macOS';
                if (ua.includes('Linux')) return 'Linux';
                if (ua.includes('Android')) return 'Android';
                if (ua.includes('iPhone') || ua.includes('iPad')) return 'iOS';
                return navigator.platform || 'Unknown';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            try {
                new AttendanceSystem();
            } catch (error) {
                console.error('AttendanceSystem ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                alert('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            }
        });

        // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬
        window.addEventListener('error', (event) => {
            console.error('ì „ì—­ ì˜¤ë¥˜:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€:', event.reason);
        });
    </script>
</body>
</html>
