// Google Apps Script ì½”ë“œ - ì¶œì„ ì²´í¬ ì‹œìŠ¤í…œ (ì™„ì „ í†µí•© ë²„ì „)

// ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID (Google Sheets URLì—ì„œ í™•ì¸ ê°€ëŠ¥)
const SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID_HERE';

// ì‹œíŠ¸ ì´ë¦„
const SHEET_NAME = 'ì¶œì„ì²´í¬';

function doPost(e) {
  console.log('doPost í˜¸ì¶œë¨');
  console.log('ìš”ì²­ ë°ì´í„°:', e);
  
  try {
    let data;
    
    // POST ìš”ì²­ ë°ì´í„° íŒŒì‹±
    if (e.postData && e.postData.contents) {
      console.log('POST ë°ì´í„° ì›ë³¸:', e.postData.contents);
      data = JSON.parse(e.postData.contents);
      console.log('íŒŒì‹±ëœ ë°ì´í„°:', data);
    } else {
      throw new Error('POST ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    // ê´€ë¦¬ì ê¸°ëŠ¥ ì²˜ë¦¬
    if (data.action) {
      return handleAdminActionPost(data);
    }
    
    // í–¥ìƒëœ ì €ì¥ í•¨ìˆ˜ ì‚¬ìš©
    console.log('í–¥ìƒëœ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì €ì¥ ì‹œì‘...');
    const result = saveToSpreadsheetEnhanced(data);
    console.log('ì €ì¥ ê²°ê³¼:', result);
    
    // JSON ì‘ë‹µ ë°˜í™˜
    const response = {
      success: true,
      message: 'ì¶œì„ì²´í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
      data: result,
      method: 'POST',
      timestamp: new Date().toISOString()
    };
    
    console.log('ì‘ë‹µ ë°ì´í„°:', response);
    
    return ContentService
      .createTextOutput(JSON.stringify(response))
      .setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    console.error('doPost ì˜¤ë¥˜:', error);
    console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
    
    const errorResponse = {
      success: false,
      message: error.toString(),
      error: error.toString(),
      method: 'POST',
      timestamp: new Date().toISOString()
    };
    
    return ContentService
      .createTextOutput(JSON.stringify(errorResponse))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  console.log('doGet í˜¸ì¶œë¨');
  console.log('GET íŒŒë¼ë¯¸í„°:', e.parameter);
  
  try {
    // ê´€ë¦¬ì ê¸°ëŠ¥ ì²˜ë¦¬
    if (e.parameter.action) {
      return handleAdminAction(e.parameter);
    }
    
    // JSONP ì½œë°± í•¨ìˆ˜ëª… í™•ì¸
    const callback = e.parameter.callback;
    
    if (callback && e.parameter.data) {
      console.log('JSONP ìš”ì²­ ì²˜ë¦¬ ì¤‘...');
      console.log('ì½œë°±:', callback);
      console.log('ë°ì´í„° ì›ë³¸:', e.parameter.data);
      
      // JSONP ìš”ì²­ ì²˜ë¦¬
      const data = JSON.parse(e.parameter.data);
      console.log('JSONP íŒŒì‹±ëœ ë°ì´í„°:', data);
      
      // í–¥ìƒëœ ì €ì¥ í•¨ìˆ˜ ì‚¬ìš©
      const result = saveToSpreadsheetEnhanced(data);
      console.log('JSONP ì €ì¥ ê²°ê³¼:', result);
      
      // JSONP ì‘ë‹µ ìƒì„±
      const responseData = {
        success: true,
        message: 'ì¶œì„ì²´í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
        data: result,
        method: 'JSONP'
      };
      
      const jsonpResponse = `${callback}(${JSON.stringify(responseData)});`;
      console.log('JSONP ì‘ë‹µ:', jsonpResponse);
      
      return ContentService
        .createTextOutput(jsonpResponse)
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
        
    } else {
      console.log('ì¼ë°˜ GET ìš”ì²­ - ìƒíƒœ í™•ì¸');
      // ì¼ë°˜ GET ìš”ì²­ - ìƒíƒœ í™•ì¸ìš©
      return ContentService
        .createTextOutput(JSON.stringify({
          success: true,
          message: 'ì¶œì„ì²´í¬ ì‹œìŠ¤í…œì´ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤.',
          timestamp: new Date().toISOString(),
          spreadsheetId: SPREADSHEET_ID ? 'ì„¤ì •ë¨' : 'ë¯¸ì„¤ì •',
          method: 'GET'
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
  } catch (error) {
    console.error('doGet ì˜¤ë¥˜:', error);
    console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
    
    if (e.parameter && e.parameter.callback) {
      // JSONP ì—ëŸ¬ ì‘ë‹µ
      const errorResponse = `${e.parameter.callback}(${JSON.stringify({
        success: false,
        message: error.toString(),
        error: error.toString(),
        method: 'JSONP_ERROR'
      })});`;
      
      return ContentService
        .createTextOutput(errorResponse)
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        message: error.toString(),
        error: error.toString(),
        method: 'GET_ERROR'
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// í–¥ìƒëœ ì €ì¥ í•¨ìˆ˜ (ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ì‹œë„)
function saveToSpreadsheetEnhanced(data) {
  console.log('=== í–¥ìƒëœ ì €ì¥ í•¨ìˆ˜ ì‹œì‘ ===');
  console.log('ë°›ì€ ë°ì´í„°:', JSON.stringify(data, null, 2));
  
  try {
    // 1ë‹¨ê³„: ê¸°ë³¸ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID í™•ì¸
    if (!SPREADSHEET_ID || SPREADSHEET_ID === 'YOUR_SPREADSHEET_ID_HERE') {
      console.warn('ê¸°ë³¸ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID ë¯¸ì„¤ì •, ë°±ì—… ë°©ì‹ìœ¼ë¡œ ì „í™˜');
      return saveToBackupSpreadsheet(data);
    }
    
    console.log('SPREADSHEET_ID:', SPREADSHEET_ID);
    
    // 2ë‹¨ê³„: ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì ‘ê·¼ ì‹œë„
    let spreadsheet;
    try {
      spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
      console.log('ê¸°ë³¸ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸° ì„±ê³µ:', spreadsheet.getName());
    } catch (openError) {
      console.error('ê¸°ë³¸ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸° ì‹¤íŒ¨:', openError);
      console.log('ë°±ì—… ë°©ì‹ìœ¼ë¡œ ì „í™˜...');
      return saveToBackupSpreadsheet(data);
    }
    
    // 3ë‹¨ê³„: ì‹œíŠ¸ í™•ì¸ ë° ìƒì„±
    let sheet = spreadsheet.getSheetByName(SHEET_NAME);
    if (!sheet) {
      console.log('ì‹œíŠ¸ê°€ ì—†ìŒ, ìƒˆë¡œ ìƒì„±...');
      sheet = spreadsheet.insertSheet(SHEET_NAME);
      
      // í—¤ë” ì„¤ì •
      const headers = [
        'ì œì¶œì¼ì‹œ(KST)', 'ì œì¶œì¼ì‹œ(ISO)', 'ì´ë¦„', 'ì†Œì†', 'ì´ë©”ì¼', 'ì—°ë½ì²˜', 
        'ìœ„ì¹˜', 'ì¢Œí‘œ', 'ê¸°ê¸°ID', 'ë¸Œë¼ìš°ì €ì •ë³´', 'ì œì¶œì‹œë„', 'ì „ì†¡ë°©ì‹'
      ];
      
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      
      // í—¤ë” ìŠ¤íƒ€ì¼
      const headerRange = sheet.getRange(1, 1, 1, headers.length);
      headerRange.setBackground('#4285f4');
      headerRange.setFontColor('white');
      headerRange.setFontWeight('bold');
      headerRange.setHorizontalAlignment('center');
      
      SpreadsheetApp.flush();
      console.log('í—¤ë” ì„¤ì • ì™„ë£Œ');
    }
    
    // 4ë‹¨ê³„: í˜„ì¬ ìƒíƒœ í™•ì¸
    const beforeLastRow = sheet.getLastRow();
    console.log('ì €ì¥ ì „ ë§ˆì§€ë§‰ í–‰:', beforeLastRow);
    
    // 5ë‹¨ê³„: ë°ì´í„° ì¤€ë¹„
    const now = new Date();
    const kstTime = Utilities.formatDate(now, 'Asia/Seoul', 'yyyy-MM-dd HH:mm:ss');
    
    const row = [
      data.timestampKor || kstTime,
      data.timestamp || now.toISOString(),
      data.name || '',
      data.affiliation || '',
      data.email || '',
      data.phone || '',
      data.location || '',
      data.coordinates || '',
      data.deviceId || '',
      data.userAgent || '',
      data.submissionAttempt || 1,
      data.method || 'Enhanced'
    ];
    
    console.log('ì €ì¥í•  í–‰ ë°ì´í„°:', row);
    
    // 6ë‹¨ê³„: ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ë°ì´í„° ì €ì¥ ì‹œë„
    try {
      // ë°©ë²• 1: appendRow ì‚¬ìš©
      sheet.appendRow(row);
      console.log('appendRow ì™„ë£Œ');
    } catch (appendError) {
      console.warn('appendRow ì‹¤íŒ¨, insertRowAfter ì‹œë„:', appendError);
      
      // ë°©ë²• 2: insertRowAfter ì‚¬ìš©
      const targetRow = beforeLastRow + 1;
      sheet.insertRowAfter(beforeLastRow);
      sheet.getRange(targetRow, 1, 1, row.length).setValues([row]);
      console.log('insertRowAfter ì™„ë£Œ');
    }
    
    // 7ë‹¨ê³„: ê°•ì œ ì €ì¥ ë° ìƒˆë¡œê³ ì¹¨
    SpreadsheetApp.flush();
    console.log('ì²« ë²ˆì§¸ flush ì™„ë£Œ');
    
    Utilities.sleep(500); // 0.5ì´ˆ ëŒ€ê¸°
    
    // ì¶”ê°€ ê°•ì œ ì €ì¥
    sheet.getRange('A1').setValue(sheet.getRange('A1').getValue());
    SpreadsheetApp.flush();
    console.log('ë‘ ë²ˆì§¸ flush ì™„ë£Œ');
    
    // 8ë‹¨ê³„: ì €ì¥ ê²°ê³¼ í™•ì¸
    const afterLastRow = sheet.getLastRow();
    console.log('ì €ì¥ í›„ ë§ˆì§€ë§‰ í–‰:', afterLastRow);
    
    if (afterLastRow <= beforeLastRow) {
      throw new Error(`ë°ì´í„°ê°€ ì €ì¥ë˜ì§€ ì•ŠìŒ. ì €ì¥ ì „: ${beforeLastRow}, ì €ì¥ í›„: ${afterLastRow}`);
    }
    
    // 9ë‹¨ê³„: ì €ì¥ëœ ë°ì´í„° ê²€ì¦
    const savedData = sheet.getRange(afterLastRow, 1, 1, row.length).getValues()[0];
    console.log('ì €ì¥ëœ ë°ì´í„° ê²€ì¦:', savedData);
    
    // 10ë‹¨ê³„: ì¤‘ë³µ ì²´í¬
    let duplicateCount = 1;
    if (afterLastRow > 1) {
      const deviceIds = sheet.getRange(2, 9, afterLastRow - 1, 1).getValues();
      const duplicates = deviceIds.filter(id => id[0] === data.deviceId);
      duplicateCount = duplicates.length;
      
      if (duplicateCount > 1) {
        console.log(`ì¤‘ë³µ ì¶œì„ ê°ì§€: ${data.deviceId}, ì´ ${duplicateCount}íšŒ`);
      }
    }
    
    const result = {
      success: true,
      rowNumber: afterLastRow,
      timestamp: now.toISOString(),
      kstTimestamp: kstTime,
      deviceId: data.deviceId,
      duplicateCount: duplicateCount,
      spreadsheetName: spreadsheet.getName(),
      spreadsheetUrl: spreadsheet.getUrl(),
      sheetName: sheet.getName(),
      savedData: savedData
    };
    
    console.log('=== ì €ì¥ ì„±ê³µ ===');
    console.log('ìµœì¢… ê²°ê³¼:', result);
    
    return result;
    
  } catch (error) {
    console.error('=== í–¥ìƒëœ ì €ì¥ ì‹¤íŒ¨ ===');
    console.error('ì˜¤ë¥˜:', error);
    console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
    
    // ë°±ì—… ì €ì¥ ì‹œë„
    console.log('ë°±ì—… ì €ì¥ ì‹œë„...');
    try {
      const backupResult = saveToBackupSpreadsheet(data);
      console.log('ë°±ì—… ì €ì¥ ì„±ê³µ:', backupResult);
      return backupResult;
    } catch (backupError) {
      console.error('ë°±ì—… ì €ì¥ë„ ì‹¤íŒ¨:', backupError);
      throw new Error(`ê¸°ë³¸ ì €ì¥ ì‹¤íŒ¨: ${error.message}, ë°±ì—… ì €ì¥ë„ ì‹¤íŒ¨: ${backupError.message}`);
    }
  }
}

// ë‹¤ë¥¸ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ë°±ì—… ì €ì¥ í•¨ìˆ˜
function saveToBackupSpreadsheet(data) {
  try {
    console.log('=== ë°±ì—… ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì €ì¥ ì‹œì‘ ===');
    
    // ìƒˆ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„± (ì„ì‹œ ë°±ì—…ìš©)
    const backupName = 'ì¶œì„ì²´í¬_ë°±ì—…_' + Utilities.formatDate(new Date(), 'Asia/Seoul', 'yyyyMMdd_HHmmss');
    const backupSpreadsheet = SpreadsheetApp.create(backupName);
    const backupSheet = backupSpreadsheet.getActiveSheet();
    backupSheet.setName('ì¶œì„ë°ì´í„°');
    
    console.log('ë°±ì—… ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„±:', backupSpreadsheet.getUrl());
    
    // í—¤ë” ì„¤ì •
    const headers = [
      'ì œì¶œì¼ì‹œ(KST)', 'ì œì¶œì¼ì‹œ(ISO)', 'ì´ë¦„', 'ì†Œì†', 'ì´ë©”ì¼', 'ì—°ë½ì²˜', 
      'ìœ„ì¹˜', 'ì¢Œí‘œ', 'ê¸°ê¸°ID', 'ë¸Œë¼ìš°ì €ì •ë³´', 'ì œì¶œì‹œë„', 'ì „ì†¡ë°©ì‹'
    ];
    
    backupSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    
    // í˜„ì¬ ì‹œê°„
    const now = new Date();
    const kstTime = Utilities.formatDate(now, 'Asia/Seoul', 'yyyy-MM-dd HH:mm:ss');
    
    // ë°ì´í„° í–‰ ì¶”ê°€
    const row = [
      data.timestampKor || kstTime,
      data.timestamp || now.toISOString(),
      data.name || '',
      data.affiliation || '',
      data.email || '',
      data.phone || '',
      data.location || '',
      data.coordinates || '',
      data.deviceId || '',
      data.userAgent || '',
      data.submissionAttempt || 1,
      'BACKUP_SAVE'
    ];
    
    backupSheet.appendRow(row);
    SpreadsheetApp.flush();
    
    console.log('ë°±ì—… ì €ì¥ ì™„ë£Œ');
    console.log('ë°±ì—… URL:', backupSpreadsheet.getUrl());
    
    return {
      success: true,
      backupUrl: backupSpreadsheet.getUrl(),
      backupId: backupSpreadsheet.getId(),
      rowData: row,
      message: 'ë°±ì—… ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì €ì¥ë¨'
    };
    
  } catch (error) {
    console.error('ë°±ì—… ì €ì¥ ì˜¤ë¥˜:', error);
    throw error;
  }
}

// ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ê°•ì œ ìƒˆë¡œê³ ì¹¨ ë° ë™ê¸°í™” í•¨ìˆ˜
function forceRefreshSpreadsheet() {
  try {
    console.log('=== ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì‹œì‘ ===');
    
    if (!SPREADSHEET_ID || SPREADSHEET_ID === 'YOUR_SPREADSHEET_ID_HERE') {
      throw new Error('SPREADSHEET_IDë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”!');
    }
    
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    console.log('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸°:', spreadsheet.getName());
    
    // ëª¨ë“  ì‹œíŠ¸ ìƒˆë¡œê³ ì¹¨
    const sheets = spreadsheet.getSheets();
    console.log('ì „ì²´ ì‹œíŠ¸ ìˆ˜:', sheets.length);
    
    sheets.forEach(sheet => {
      console.log(`ì‹œíŠ¸ "${sheet.getName()}" ìƒˆë¡œê³ ì¹¨ ì¤‘...`);
      // ê°•ì œ ê³„ì‚° ìƒˆë¡œê³ ì¹¨
      sheet.getRange("A1").setValue(sheet.getRange("A1").getValue());
    });
    
    // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ê°•ì œ ì €ì¥
    SpreadsheetApp.flush();
    console.log('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ í”ŒëŸ¬ì‹œ ì™„ë£Œ');
    
    // ì ì‹œ ëŒ€ê¸° í›„ ë‹¤ì‹œ í™•ì¸
    Utilities.sleep(1000);
    
    const targetSheet = spreadsheet.getSheetByName(SHEET_NAME);
    if (targetSheet) {
      const lastRow = targetSheet.getLastRow();
      const lastCol = targetSheet.getLastColumn();
      console.log(`ëŒ€ìƒ ì‹œíŠ¸ "${SHEET_NAME}" ìƒíƒœ:`, {
        lastRow: lastRow,
        lastColumn: lastCol,
        hasData: lastRow > 0
      });
      
      if (lastRow > 0) {
        const recentData = targetSheet.getRange(Math.max(1, lastRow - 2), 1, Math.min(3, lastRow), lastCol).getValues();
        console.log('ìµœê·¼ ë°ì´í„° (ìµœëŒ€ 3í–‰):', recentData);
      }
    }
    
    return {
      success: true,
      message: 'ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ',
      spreadsheetUrl: spreadsheet.getUrl(),
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    console.error('ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', error);
    throw error;
  }
}

// ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒíƒœ í™•ì¸ í•¨ìˆ˜
function checkSpreadsheetStatus() {
  console.log('=== ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒíƒœ í™•ì¸ ===');
  console.log('SPREADSHEET_ID:', SPREADSHEET_ID);
  
  try {
    if (!SPREADSHEET_ID || SPREADSHEET_ID === 'YOUR_SPREADSHEET_ID_HERE') {
      console.error('SPREADSHEET_IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
      return { error: 'SPREADSHEET_ID ë¯¸ì„¤ì •' };
    }
    
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    console.log('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì´ë¦„:', spreadsheet.getName());
    console.log('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URL:', spreadsheet.getUrl());
    
    const sheet = spreadsheet.getSheetByName(SHEET_NAME);
    if (sheet) {
      console.log('ì‹œíŠ¸ ì¡´ì¬í•¨:', SHEET_NAME);
      console.log('ë§ˆì§€ë§‰ í–‰:', sheet.getLastRow());
      console.log('ë§ˆì§€ë§‰ ì—´:', sheet.getLastColumn());
      
      if (sheet.getLastRow() > 0) {
        const data = sheet.getRange(1, 1, Math.min(sheet.getLastRow(), 5), sheet.getLastColumn()).getValues();
        console.log('ì‹œíŠ¸ ë°ì´í„° (ìµœëŒ€ 5í–‰):', data);
      }
    } else {
      console.log('ì‹œíŠ¸ ì—†ìŒ:', SHEET_NAME);
    }
    
    return {
      success: true,
      spreadsheetName: spreadsheet.getName(),
      spreadsheetUrl: spreadsheet.getUrl(),
      sheetExists: !!sheet,
      lastRow: sheet ? sheet.getLastRow() : 0
    };
    
  } catch (error) {
    console.error('ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
    return { error: error.toString() };
  }
}

// ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì´ˆê¸°í™” í•¨ìˆ˜
function initializeSpreadsheet() {
  console.log('=== ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì´ˆê¸°í™” ì‹œì‘ ===');
  
  try {
    if (!SPREADSHEET_ID || SPREADSHEET_ID === 'YOUR_SPREADSHEET_ID_HERE') {
      throw new Error('SPREADSHEET_IDë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”!');
    }
    
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    console.log('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸° ì„±ê³µ:', spreadsheet.getName());
    
    let sheet = spreadsheet.getSheetByName(SHEET_NAME);
    
    if (sheet) {
      console.log('ê¸°ì¡´ ì‹œíŠ¸ ë°œê²¬, ì´ˆê¸°í™” ì¤‘...');
      sheet.clear();
    } else {
      console.log('ìƒˆ ì‹œíŠ¸ ìƒì„± ì¤‘...');
      sheet = spreadsheet.insertSheet(SHEET_NAME);
    }
    
    // í—¤ë” ì„¤ì •
    const headers = [
      'ì œì¶œì¼ì‹œ(KST)', 'ì œì¶œì¼ì‹œ(ISO)', 'ì´ë¦„', 'ì†Œì†', 'ì´ë©”ì¼', 'ì—°ë½ì²˜', 
      'ìœ„ì¹˜', 'ì¢Œí‘œ', 'ê¸°ê¸°ID', 'ë¸Œë¼ìš°ì €ì •ë³´', 'ì œì¶œì‹œë„', 'ì „ì†¡ë°©ì‹'
    ];
    
    console.log('í—¤ë” ì„¤ì • ì¤‘...');
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    
    // í—¤ë” ìŠ¤íƒ€ì¼
    const headerRange = sheet.getRange(1, 1, 1, headers.length);
    headerRange.setBackground('#4285f4');
    headerRange.setFontColor('white');
    headerRange.setFontWeight('bold');
    headerRange.setHorizontalAlignment('center');
    
    // ì—´ ë„ˆë¹„ ìë™ ì¡°ì •
    sheet.autoResizeColumns(1, headers.length);
    
    // ê°•ì œ ì €ì¥
    SpreadsheetApp.flush();
    
    console.log('=== ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì´ˆê¸°í™” ì™„ë£Œ ===');
    return { 
      success: true, 
      message: 'ì´ˆê¸°í™” ì™„ë£Œ',
      spreadsheetName: spreadsheet.getName(),
      spreadsheetUrl: spreadsheet.getUrl()
    };
    
  } catch (error) {
    console.error('=== ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì´ˆê¸°í™” ì˜¤ë¥˜ ===');
    console.error('ì˜¤ë¥˜:', error);
    throw error;
  }
}

// í–¥ìƒëœ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
function testSaveDataEnhanced() {
  console.log('=== í–¥ìƒëœ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
  
  const testData = {
    name: 'í–¥ìƒëœí…ŒìŠ¤íŠ¸_' + Date.now(),
    affiliation: 'í…ŒìŠ¤íŠ¸ê¸°ê´€',
    email: 'test@example.com',
    phone: '010-1234-5678',
    location: 'í…ŒìŠ¤íŠ¸ìœ„ì¹˜',
    coordinates: '37.5665,126.9780',
    deviceId: 'enhanced_test_' + Date.now(),
    timestamp: new Date().toISOString(),
    timestampKor: new Date().toLocaleString('ko-KR'),
    userAgent: 'Enhanced Test Browser',
    submissionAttempt: 1,
    method: 'ENHANCED_TEST'
  };
  
  console.log('í…ŒìŠ¤íŠ¸ ë°ì´í„°:', testData);
  
  try {
    const result = saveToSpreadsheetEnhanced(testData);
    console.log('=== í–¥ìƒëœ í…ŒìŠ¤íŠ¸ ì„±ê³µ ===');
    console.log('ê²°ê³¼:', result);
    return result;
  } catch (error) {
    console.error('=== í–¥ìƒëœ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ===');
    console.error('ì˜¤ë¥˜:', error);
    throw error;
  }
}

// ê°•ì œ ìƒˆë¡œê³ ì¹¨ í›„ í…ŒìŠ¤íŠ¸
function refreshAndTest() {
  console.log('=== ìƒˆë¡œê³ ì¹¨ í›„ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
  
  try {
    // 1ë‹¨ê³„: ê°•ì œ ìƒˆë¡œê³ ì¹¨
    console.log('1ë‹¨ê³„: ê°•ì œ ìƒˆë¡œê³ ì¹¨...');
    const refreshResult = forceRefreshSpreadsheet();
    console.log('ìƒˆë¡œê³ ì¹¨ ê²°ê³¼:', refreshResult);
    
    // 2ë‹¨ê³„: ì ì‹œ ëŒ€ê¸°
    console.log('2ë‹¨ê³„: ëŒ€ê¸° ì¤‘ (2ì´ˆ)...');
    Utilities.sleep(2000);
    
    // 3ë‹¨ê³„: í–¥ìƒëœ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    console.log('3ë‹¨ê³„: í–¥ìƒëœ í…ŒìŠ¤íŠ¸ ì‹¤í–‰...');
    const testResult = testSaveDataEnhanced();
    console.log('í…ŒìŠ¤íŠ¸ ê²°ê³¼:', testResult);
    
    // 4ë‹¨ê³„: ë‹¤ì‹œ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ í™•ì¸
    console.log('4ë‹¨ê³„: ê²°ê³¼ í™•ì¸ì„ ìœ„í•œ ìƒˆë¡œê³ ì¹¨...');
    Utilities.sleep(1000);
    const finalRefresh = forceRefreshSpreadsheet();
    console.log('ìµœì¢… ìƒˆë¡œê³ ì¹¨ ê²°ê³¼:', finalRefresh);
    
    return {
      success: true,
      refreshResult: refreshResult,
      testResult: testResult,
      finalRefresh: finalRefresh
    };
    
  } catch (error) {
    console.error('=== ìƒˆë¡œê³ ì¹¨ í›„ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ===');
    console.error('ì˜¤ë¥˜:', error);
    throw error;
  }
}

// ì™„ì „ ì´ˆê¸°í™” í›„ í…ŒìŠ¤íŠ¸
function fullResetAndTest() {
  console.log('=== ì™„ì „ ì´ˆê¸°í™” í›„ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
  
  try {
    // 1ë‹¨ê³„: ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì™„ì „ ì´ˆê¸°í™”
    console.log('1ë‹¨ê³„: ì™„ì „ ì´ˆê¸°í™”...');
    const initResult = initializeSpreadsheet();
    console.log('ì´ˆê¸°í™” ê²°ê³¼:', initResult);
    
    // 2ë‹¨ê³„: ê°•ì œ ì €ì¥ ë° ëŒ€ê¸°
    console.log('2ë‹¨ê³„: ê°•ì œ ì €ì¥ ë° ëŒ€ê¸°...');
    SpreadsheetApp.flush();
    Utilities.sleep(3000);
    
    // 3ë‹¨ê³„: ìƒíƒœ í™•ì¸
    console.log('3ë‹¨ê³„: ìƒíƒœ í™•ì¸...');
    const statusResult = checkSpreadsheetStatus();
    console.log('ìƒíƒœ í™•ì¸ ê²°ê³¼:', statusResult);
    
    // 4ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ë°ì´í„° ì €ì¥
    console.log('4ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ë°ì´í„° ì €ì¥...');
    const testResult = testSaveDataEnhanced();
    console.log('í…ŒìŠ¤íŠ¸ ì €ì¥ ê²°ê³¼:', testResult);
    
    // 5ë‹¨ê³„: ìµœì¢… í™•ì¸
    console.log('5ë‹¨ê³„: ìµœì¢… í™•ì¸...');
    Utilities.sleep(2000);
    const finalStatus = checkSpreadsheetStatus();
    console.log('ìµœì¢… ìƒíƒœ:', finalStatus);
    
    return {
      success: true,
      initResult: initResult,
      statusResult: statusResult,
      testResult: testResult,
      finalStatus: finalStatus
    };
    
  } catch (error) {
    console.error('=== ì™„ì „ ì´ˆê¸°í™” í›„ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ===');
    console.error('ì˜¤ë¥˜:', error);
    throw error;
  }
}

// ë°±ì—… í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
function testBackupSave() {
  console.log('=== ë°±ì—… ì €ì¥ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
  
  const testData = {
    name: 'ë°±ì—…í…ŒìŠ¤íŠ¸_' + Date.now(),
    affiliation: 'ë°±ì—…í…ŒìŠ¤íŠ¸ê¸°ê´€',
    email: 'backup@test.com',
    phone: '010-9999-9999',
    location: 'ë°±ì—…í…ŒìŠ¤íŠ¸ìœ„ì¹˜',
    coordinates: '37.5665,126.9780',
    deviceId: 'backup_test_' + Date.now(),
    timestamp: new Date().toISOString(),
    timestampKor: new Date().toLocaleString('ko-KR'),
    userAgent: 'Backup Test Browser',
    submissionAttempt: 1,
    method: 'BACKUP_TEST'
  };
  
  try {
    const result = saveToBackupSpreadsheet(testData);
    console.log('=== ë°±ì—… ì €ì¥ í…ŒìŠ¤íŠ¸ ì„±ê³µ ===');
    console.log('ë°±ì—… ê²°ê³¼:', result);
    console.log('ë°±ì—… ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URL:', result.backupUrl);
    return result;
  } catch (error) {
    console.error('=== ë°±ì—… ì €ì¥ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ===');
    console.error('ì˜¤ë¥˜:', error);
    throw error;
  }
}

// ê´€ë¦¬ì ê¸°ëŠ¥ ì²˜ë¦¬ (GET ìš”ì²­) - ê°•í™”ëœ ë²„ì „
function handleAdminAction(params) {
  console.log('=== ê´€ë¦¬ì GET ì•¡ì…˜ ì²˜ë¦¬ ===');
  console.log('ì•¡ì…˜:', params.action);
  console.log('ëª¨ë“  íŒŒë¼ë¯¸í„°:', params);
  
  try {
    let result;
    
    switch (params.action) {
      case 'getStats':
        console.log('í†µê³„ ì¡°íšŒ ìš”ì²­');
        result = getAttendanceStats();
        break;
        
      case 'getSettings':
        console.log('ì„¤ì • ì¡°íšŒ ìš”ì²­');
        result = getSystemSettings();
        break;
        
      case 'exportData':
        console.log('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ìš”ì²­');
        result = exportAttendanceData();
        break;
        
      case 'clearAllData':
        console.log('ëª¨ë“  ë°ì´í„° ì‚­ì œ ìš”ì²­ (GET)');
        // ë³´ì•ˆ í™•ì¸
        if (!params.adminPassword || params.adminPassword.length < 6) {
          throw new Error('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
        }
        result = clearAllAttendanceData();
        break;
        
      case 'updateSettings':
        console.log('ì„¤ì • ì—…ë°ì´íŠ¸ ìš”ì²­ (GET)');
        if (!params.adminPassword || params.adminPassword.length < 6) {
          throw new Error('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
        }
        // GET ë°©ì‹ìœ¼ë¡œ ì „ë‹¬ëœ ì„¤ì • íŒŒë¼ë¯¸í„° ì²˜ë¦¬
        const settings = {
          eventTitle: params.eventTitle,
          eventDescription: params.eventDescription,
          manualInstruction: params.manualInstruction
        };
        result = updateSystemSettings(settings);
        break;
        
      case 'updatePassword':
        console.log('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì•Œë¦¼');
        if (!params.adminPassword || params.adminPassword.length < 6) {
          throw new Error('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
        }
        result = {
          success: true,
          message: 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì•Œë¦¼ ìˆ˜ì‹ ë¨',
          timestamp: new Date().toISOString()
        };
        break;
        
      case 'updateGPSRadius':
        console.log('GPS ë°˜ê²½ ì—…ë°ì´íŠ¸ ìš”ì²­');
        if (!params.adminPassword || params.adminPassword.length < 6) {
          throw new Error('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
        }
        const radius = parseInt(params.gpsRadius);
        if (isNaN(radius) || radius < 5 || radius > 100) {
          throw new Error('GPS ë°˜ê²½ì€ 5-100ë¯¸í„° ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        }
        result = updateGPSRadius(radius);
        break;
        
      case 'notifyReset':
        console.log('ì¤‘ë³µ ë°©ì§€ ì´ˆê¸°í™” ì•Œë¦¼');
        if (!params.adminPassword || params.adminPassword.length < 6) {
          throw new Error('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
        }
        result = {
          success: true,
          message: 'ì¤‘ë³µ ë°©ì§€ ì´ˆê¸°í™” ì•Œë¦¼ ìˆ˜ì‹ ë¨',
          timestamp: new Date().toISOString()
        };
        break;
        
      default:
        throw new Error('ì•Œ ìˆ˜ ì—†ëŠ” ê´€ë¦¬ì ì•¡ì…˜: ' + params.action);
    }
    
    console.log('ì•¡ì…˜ ì²˜ë¦¬ ê²°ê³¼:', result);
    
    // JSONP ì½œë°±ì´ ìˆìœ¼ë©´ JSONP ì‘ë‹µ, ì—†ìœ¼ë©´ JSON ì‘ë‹µ
    if (params.callback) {
      console.log('JSONP ì½œë°± ì‘ë‹µ:', params.callback);
      const jsonpResponse = params.callback + '(' + JSON.stringify(result) + ');';
      return ContentService
        .createTextOutput(jsonpResponse)
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    } else {
      console.log('ì¼ë°˜ JSON ì‘ë‹µ');
      return ContentService
        .createTextOutput(JSON.stringify(result))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
  } catch (error) {
    console.error('ê´€ë¦¬ì ì•¡ì…˜ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
    
    const errorResult = {
      success: false,
      message: error.toString(),
      error: error.toString(),
      action: params.action,
      timestamp: new Date().toISOString()
    };
    
    // JSONP ì½œë°±ì´ ìˆìœ¼ë©´ JSONP ì˜¤ë¥˜ ì‘ë‹µ
    if (params.callback) {
      const jsonpErrorResponse = params.callback + '(' + JSON.stringify(errorResult) + ');';
      return ContentService
        .createTextOutput(jsonpErrorResponse)
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    } else {
      return ContentService
        .createTextOutput(JSON.stringify(errorResult))
        .setMimeType(ContentService.MimeType.JSON);
    }
  }
}

// ê´€ë¦¬ì ê¸°ëŠ¥ ì²˜ë¦¬ (POST ìš”ì²­)
function handleAdminActionPost(data) {
  console.log('ê´€ë¦¬ì POST ì•¡ì…˜:', data.action);
  
  try {
    switch (data.action) {
      case 'clearAllData':
        // ê°„ë‹¨í•œ ë³´ì•ˆ í™•ì¸
        if (!data.adminPassword || data.adminPassword.length < 6) {
          throw new Error('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
        }
        
        const clearResult = clearAllAttendanceData();
        return ContentService
          .createTextOutput(JSON.stringify(clearResult))
          .setMimeType(ContentService.MimeType.JSON);
          
      case 'updateSettings':
        const updateResult = updateSystemSettings(data.settings);
        return ContentService
          .createTextOutput(JSON.stringify(updateResult))
          .setMimeType(ContentService.MimeType.JSON);
          
      default:
        throw new Error('ì•Œ ìˆ˜ ì—†ëŠ” ê´€ë¦¬ì ì•¡ì…˜: ' + data.action);
    }
  } catch (error) {
    console.error('ê´€ë¦¬ì POST ì•¡ì…˜ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        message: error.toString(),
        error: error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// ì¶œì„ ë°ì´í„° ë‚´ë³´ë‚´ê¸° - ê°•í™”ëœ ë²„ì „
function exportAttendanceData() {
  try {
    console.log('=== ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì‹œì‘ ===');
    
    if (!SPREADSHEET_ID || SPREADSHEET_ID === 'YOUR_SPREADSHEET_ID_HERE') {
      console.warn('SPREADSHEET_ID ë¯¸ì„¤ì •');
      throw new Error('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Apps Script ì½”ë“œì—ì„œ SPREADSHEET_IDë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
    }
    
    console.log('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID:', SPREADSHEET_ID);
    
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    const url = spreadsheet.getUrl();
    const name = spreadsheet.getName();
    
    console.log('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì´ë¦„:', name);
    console.log('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URL:', url);
    
    // ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    const sheet = spreadsheet.getSheetByName(SHEET_NAME);
    let dataInfo = 'ë°ì´í„° ì—†ìŒ';
    
    if (sheet) {
      const lastRow = sheet.getLastRow();
      const lastCol = sheet.getLastColumn();
      dataInfo = `${lastRow - 1}í–‰ Ã— ${lastCol}ì—´ (í—¤ë” ì œì™¸)`;
      console.log('ë°ì´í„° ì •ë³´:', dataInfo);
    } else {
      console.log('ì‹œíŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ:', SHEET_NAME);
    }
    
    const result = {
      success: true,
      spreadsheetUrl: url,
      spreadsheetId: SPREADSHEET_ID,
      spreadsheetName: name,
      sheetName: SHEET_NAME,
      dataInfo: dataInfo,
      exportTime: new Date().toISOString(),
      message: 'ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì„±ê³µ'
    };
    
    console.log('=== ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ ===');
    console.log('ê²°ê³¼:', result);
    
    return result;
    
  } catch (error) {
    console.error('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
    console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
    
    // ìƒì„¸í•œ ì˜¤ë¥˜ ì •ë³´ ë°˜í™˜
    const errorResult = {
      success: false,
      message: error.toString(),
      error: error.toString(),
      spreadsheetId: SPREADSHEET_ID || 'ë¯¸ì„¤ì •',
      sheetName: SHEET_NAME,
      exportTime: new Date().toISOString(),
      troubleshooting: [
        'SPREADSHEET_IDê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸',
        'ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ëŒ€í•œ ì½ê¸° ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸',
        'ìŠ¤í”„ë ˆë“œì‹œíŠ¸ê°€ ì‚­ì œë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸'
      ]
    };
    
    console.log('ì˜¤ë¥˜ ê²°ê³¼:', errorResult);
    throw error;
  }
}

// ëª¨ë“  ì¶œì„ ë°ì´í„° ì‚­ì œ
function clearAllAttendanceData() {
  try {
    console.log('=== ëª¨ë“  ë°ì´í„° ì‚­ì œ ì‹œì‘ ===');
    
    if (!SPREADSHEET_ID || SPREADSHEET_ID === 'YOUR_SPREADSHEET_ID_HERE') {
      throw new Error('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }
    
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = spreadsheet.getSheetByName(SHEET_NAME);
    
    if (!sheet) {
      console.log('ì‚­ì œí•  ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return { success: true, message: 'ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.' };
    }
    
    const lastRow = sheet.getLastRow();
    console.log('ì‚­ì œ ì „ ë§ˆì§€ë§‰ í–‰:', lastRow);
    
    if (lastRow > 1) {
      // í—¤ë”(1í–‰)ë¥¼ ì œì™¸í•œ ëª¨ë“  ë°ì´í„° ì‚­ì œ
      sheet.deleteRows(2, lastRow - 1);
      console.log('ë°ì´í„° í–‰ ì‚­ì œ ì™„ë£Œ');
    }
    
    // ê°•ì œ ì €ì¥
    SpreadsheetApp.flush();
    
    const afterLastRow = sheet.getLastRow();
    console.log('ì‚­ì œ í›„ ë§ˆì§€ë§‰ í–‰:', afterLastRow);
    
    console.log('=== ëª¨ë“  ë°ì´í„° ì‚­ì œ ì™„ë£Œ ===');
    
    return {
      success: true,
      message: 'ëª¨ë“  ì¶œì„ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.',
      deletedRows: lastRow - 1,
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    console.error('ë°ì´í„° ì‚­ì œ ì˜¤ë¥˜:', error);
    throw error;
  }
}

// ì‹œìŠ¤í…œ ì„¤ì • ì—…ë°ì´íŠ¸
function updateSystemSettings(settings) {
  try {
    console.log('=== ì‹œìŠ¤í…œ ì„¤ì • ì—…ë°ì´íŠ¸ ===');
    console.log('ìƒˆ ì„¤ì •:', settings);
    
    // PropertiesServiceë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¤ì • ì €ì¥
    const properties = PropertiesService.getScriptProperties();
    
    if (settings.eventTitle) {
      properties.setProperty('eventTitle', settings.eventTitle);
    }
    
    if (settings.eventDescription) {
      properties.setProperty('eventDescription', settings.eventDescription);
    }
    
    if (settings.manualInstruction) {
      properties.setProperty('manualInstruction', settings.manualInstruction);
    }
    
    if (settings.locations) {
      properties.setProperty('allowedLocations', JSON.stringify(settings.locations));
    }
    
    console.log('ì„¤ì • ì €ì¥ ì™„ë£Œ');
    
    return {
      success: true,
      message: 'ì‹œìŠ¤í…œ ì„¤ì •ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.',
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    console.error('ì„¤ì • ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    throw error;
  }
}

// ì‹œìŠ¤í…œ ì„¤ì • ì¡°íšŒ
function getSystemSettings() {
  try {
    const properties = PropertiesService.getScriptProperties();
    
    const settings = {
      eventTitle: properties.getProperty('eventTitle') || 'ğŸ“ ì„¸ë¯¸ë‚˜ì‹¤ ì¶œì„ ì²´í¬',
      eventDescription: properties.getProperty('eventDescription') || 'í–‰ì‚¬ ì°¸ì„ í™•ì¸ì„ ìœ„í•´ ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”',
      manualInstruction: properties.getProperty('manualInstruction') || 'í–‰ì‚¬ì¥ ì•ìª½ì— ë¹„ì¹˜ëœ <strong>\'ì°¸ì„ì ëª…ë¶€\'</strong>ì— ì§ì ‘ ê¸°ì¬í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.',
      allowedLocations: JSON.parse(properties.getProperty('allowedLocations') || '[]')
    };
    
    // ê¸°ë³¸ ìœ„ì¹˜ ì„¤ì •ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì •
    if (settings.allowedLocations.length === 0) {
      settings.allowedLocations = [
        { name: 'ë‹¨í˜¸í™€', lat: 37.228848, lng: 127.167855, radius: 30 },
        { name: 'ë²½ì†Œí™€', lat: 37.228767, lng: 127.167449, radius: 30 },
        { name: 'ëŒ€í•™êµ ë³¸ê´€', lat: 37.227239, lng: 127.166598, radius: 30 }
      ];
    }
    
    return {
      success: true,
      settings: settings,
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    console.error('ì„¤ì • ì¡°íšŒ ì˜¤ë¥˜:', error);
    throw error;
  }
}

// í†µê³„ ì¡°íšŒ í•¨ìˆ˜ (ê°•í™”ëœ ë²„ì „)
function getAttendanceStats() {
  try {
    console.log('=== í†µê³„ ì¡°íšŒ ì‹œì‘ ===');
    
    if (!SPREADSHEET_ID || SPREADSHEET_ID === 'YOUR_SPREADSHEET_ID_HERE') {
      console.warn('SPREADSHEET_ID ë¯¸ì„¤ì •, ê¸°ë³¸ í†µê³„ ë°˜í™˜');
      return {
        success: true,
        totalAttendees: 0,
        uniqueDevices: 0,
        duplicates: 0,
        lastUpdate: new Date().toISOString(),
        message: 'SPREADSHEET_ID ë¯¸ì„¤ì •'
      };
    }
    
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = spreadsheet.getSheetByName(SHEET_NAME);
    
    if (!sheet) {
      console.log('ì‹œíŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ');
      return {
        success: true,
        totalAttendees: 0,
        uniqueDevices: 0,
        duplicates: 0,
        lastUpdate: new Date().toISOString(),
        message: 'ë°ì´í„° ì‹œíŠ¸ ì—†ìŒ'
      };
    }
    
    const lastRow = sheet.getLastRow();
    console.log('ë§ˆì§€ë§‰ í–‰:', lastRow);
    
    if (lastRow <= 1) {
      console.log('ë°ì´í„° ì—†ìŒ (í—¤ë”ë§Œ ì¡´ì¬)');
      return {
        success: true,
        totalAttendees: 0,
        uniqueDevices: 0,
        duplicates: 0,
        lastUpdate: new Date().toISOString(),
        message: 'ì¶œì„ ë°ì´í„° ì—†ìŒ'
      };
    }
    
    // ëª¨ë“  ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í—¤ë” ì œì™¸)
    const dataRange = sheet.getRange(2, 1, lastRow - 1, sheet.getLastColumn());
    const data = dataRange.getValues();
    console.log('ë°ì´í„° í–‰ ìˆ˜:', data.length);
    
    // ê¸°ê¸° IDëŠ” 9ë²ˆì§¸ ì—´ (ì¸ë±ìŠ¤ 8)
    const deviceIds = data.map(row => row[8]).filter(id => id && id.toString().trim() !== '');
    console.log('ìœ íš¨í•œ ê¸°ê¸° ID ìˆ˜:', deviceIds.length);
    
    // ê³ ìœ  ê¸°ê¸° ìˆ˜ ê³„ì‚°
    const uniqueDeviceIds = [...new Set(deviceIds)];
    const uniqueDevices = uniqueDeviceIds.length;
    const totalAttendees = deviceIds.length;
    const duplicates = totalAttendees - uniqueDevices;
    
    console.log('í†µê³„ ê³„ì‚° ì™„ë£Œ:', {
      totalAttendees: totalAttendees,
      uniqueDevices: uniqueDevices,
      duplicates: duplicates
    });
    
    // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ (ê°€ì¥ ìµœê·¼ ë°ì´í„°ì˜ íƒ€ì„ìŠ¤íƒ¬í”„)
    let lastUpdate = new Date().toISOString();
    if (data.length > 0) {
      // ë‘ ë²ˆì§¸ ì—´(ì¸ë±ìŠ¤ 1)ì´ ISO íƒ€ì„ìŠ¤íƒ¬í”„
      const timestamps = data.map(row => row[1]).filter(ts => ts);
      if (timestamps.length > 0) {
        const latestTimestamp = timestamps[timestamps.length - 1];
        if (latestTimestamp instanceof Date) {
          lastUpdate = latestTimestamp.toISOString();
        } else if (typeof latestTimestamp === 'string') {
          lastUpdate = latestTimestamp;
        }
      }
    }
    
    const result = {
      success: true,
      totalAttendees: totalAttendees,
      uniqueDevices: uniqueDevices,
      duplicates: duplicates,
      lastUpdate: lastUpdate,
      spreadsheetName: spreadsheet.getName(),
      dataRows: data.length,
      timestamp: new Date().toISOString()
    };
    
    console.log('=== í†µê³„ ì¡°íšŒ ì™„ë£Œ ===');
    console.log('ìµœì¢… ê²°ê³¼:', result);
    
    return result;
    
  } catch (error) {
    console.error('í†µê³„ ì¡°íšŒ ì˜¤ë¥˜:', error);
    console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
    
    // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ê¸°ë³¸ êµ¬ì¡° ë°˜í™˜
    return {
      success: false,
      totalAttendees: 0,
      uniqueDevices: 0,
      duplicates: 0,
      lastUpdate: new Date().toISOString(),
      error: error.toString(),
      message: 'í†µê³„ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ'
    };
  }
}
